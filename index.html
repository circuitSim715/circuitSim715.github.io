<!DOCTYPE html>

<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Simulic Pro â€” I2C OLED Update</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@400;600;700;800&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep:    #0f1520;
            --bg-base:    #141c2e;
            --bg-surface: rgba(255,255,255,0.03);
            --bg-raised:  rgba(255,255,255,0.05);
            --bg-hover:   rgba(255,255,255,0.07);
            --bg-active:  rgba(0,212,255,0.08);

```
        --glass-border:       rgba(255,255,255,0.07);
        --glass-border-light: rgba(255,255,255,0.12);
        --glass-border-cyan:  rgba(0,212,255,0.25);

        --cyan:      #00d4ff;
        --cyan-dim:  #0088aa;
        --cyan-mute: rgba(0,212,255,0.15);
        --green:     #00e676;
        --green-dim: rgba(0,230,118,0.12);
        --amber:     #ffb700;
        --red:       #ff4757;
        --red-dim:   rgba(255,71,87,0.12);
        --purple:    #a78bfa;

        --text-bright: #e8ecf4;
        --text-mid:    #8892a4;
        --text-dim:    #3d4559;
        --text-cyan:   #00d4ff;

        --radius-sm: 4px;
        --radius-md: 6px;
        --radius-lg: 10px;
    }

    * { user-select: none; box-sizing: border-box; touch-action: none; margin: 0; padding: 0; }

    body {
        background: var(--bg-deep);
        color: var(--text-bright);
        font-family: 'Inter', sans-serif;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
    }

    body::before {
        content: '';
        position: fixed;
        inset: 0;
        background:
            radial-gradient(ellipse 60% 40% at 15% 0%, rgba(0,212,255,0.04) 0%, transparent 70%),
            radial-gradient(ellipse 40% 30% at 85% 100%, rgba(0,230,118,0.03) 0%, transparent 70%);
        pointer-events: none;
        z-index: 0;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HEADER BAR
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #header {
        position: relative;
        z-index: 10;
        display: flex;
        align-items: center;
        padding: 0 18px;
        height: 46px;
        background: rgba(11,14,23,0.9);
        border-bottom: 1px solid var(--glass-border);
        backdrop-filter: blur(20px);
        flex-shrink: 0;
        gap: 16px;
    }

    .logo-wrap {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .logo-icon {
        width: 28px; height: 28px;
        background: linear-gradient(135deg, var(--cyan) 0%, #0088aa 100%);
        border-radius: var(--radius-sm);
        display: flex; align-items: center; justify-content: center;
        font-size: 13px; font-weight: 800;
        color: #07090f;
        font-family: 'Syne', sans-serif;
        letter-spacing: -1px;
        flex-shrink: 0;
    }

    .logo-text {
        font-family: 'Syne', sans-serif;
        font-weight: 800;
        font-size: 14px;
        letter-spacing: 2px;
        color: var(--text-bright);
    }

    .logo-version {
        font-family: 'DM Mono', monospace;
        font-size: 9px;
        color: var(--text-dim);
        letter-spacing: 1px;
        padding: 2px 6px;
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-sm);
        background: var(--bg-surface);
        font-weight: 300;
    }

    .header-divider {
        width: 1px; height: 20px;
        background: var(--glass-border);
    }

    .status-pill {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 3px 10px;
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        background: var(--bg-surface);
    }

    .status-dot {
        width: 5px; height: 5px;
        border-radius: 50%;
        background: var(--green);
        box-shadow: 0 0 6px var(--green);
        animation: blink 3s ease-in-out infinite;
    }

    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
    }

    .status-label {
        font-family: 'DM Mono', monospace;
        font-size: 9px;
        color: var(--text-mid);
        letter-spacing: 1px;
        font-weight: 300;
    }

    .header-right {
        margin-left: auto;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .hdr-btn {
        height: 28px;
        padding: 0 12px;
        background: var(--bg-surface);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-sm);
        color: var(--text-mid);
        cursor: pointer;
        font-family: 'DM Mono', monospace;
        font-size: 10px;
        font-weight: 400;
        letter-spacing: 0.5px;
        transition: all 0.15s;
        white-space: nowrap;
    }

    .hdr-btn:hover { background: var(--bg-hover); border-color: var(--glass-border-light); color: var(--text-bright); }

    .hdr-btn-mode { color: var(--cyan-dim); border-color: rgba(0,136,170,0.3); }
    .hdr-btn-mode:hover { color: var(--cyan); border-color: var(--glass-border-cyan); background: var(--bg-active); }

    .hdr-btn-danger { color: var(--red); border-color: rgba(255,71,87,0.2); background: var(--red-dim); }
    .hdr-btn-danger:hover { background: rgba(255,71,87,0.18); border-color: rgba(255,71,87,0.4); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CATEGORY TOOLBAR
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #ui-top {
        position: relative;
        z-index: 9;
        display: flex;
        align-items: stretch;
        height: 38px;
        background: rgba(11,14,23,0.7);
        border-bottom: 1px solid var(--glass-border);
        backdrop-filter: blur(12px);
        overflow-x: auto;
        flex-shrink: 0;
    }

    #ui-top::-webkit-scrollbar { height: 0; }

    .cat-group {
        display: flex;
        align-items: stretch;
        padding: 0 6px;
        gap: 2px;
        border-right: 1px solid var(--glass-border);
    }

    .cat-group:last-child { border-right: none; margin-left: auto; }

    .cat-btn {
        padding: 0 14px;
        background: transparent;
        border: none;
        color: var(--text-dim);
        cursor: pointer;
        font-family: 'Inter', sans-serif;
        font-size: 11px;
        font-weight: 500;
        letter-spacing: 0.3px;
        white-space: nowrap;
        border-radius: var(--radius-sm);
        position: relative;
        transition: color 0.15s, background 0.15s;
    }

    .cat-btn:hover { color: var(--text-mid); background: var(--bg-surface); }

    .cat-btn.active {
        color: var(--cyan);
        background: var(--bg-active);
    }

    .cat-btn.active::after {
        content: '';
        position: absolute;
        bottom: 0; left: 12px; right: 12px;
        height: 1.5px;
        background: var(--cyan);
        border-radius: 1px;
    }

    .cat-btn-demo { color: rgba(167,139,250,0.5); }
    .cat-btn-demo:hover { color: var(--purple); }
    .cat-btn-demo.active { color: var(--purple); background: rgba(167,139,250,0.08); }
    .cat-btn-demo.active::after { background: var(--purple); }

    .cat-btn-manual { color: rgba(255,183,0,0.5); }
    .cat-btn-manual:hover { color: var(--amber); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SPAWN / COMPONENT BAR
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #ui-sub {
        position: relative;
        z-index: 8;
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 0 14px;
        height: 38px;
        background: rgba(7,9,15,0.6);
        border-bottom: 1px solid var(--glass-border);
        backdrop-filter: blur(8px);
        overflow-x: auto;
        flex-shrink: 0;
    }

    #ui-sub::-webkit-scrollbar { height: 0; }

    .sub-hint {
        font-family: 'DM Mono', monospace;
        font-size: 9px;
        color: var(--text-dim);
        letter-spacing: 1px;
        font-weight: 300;
    }

    .spawn-btn {
        height: 24px;
        padding: 0 12px;
        background: var(--bg-surface);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-sm);
        color: var(--text-mid);
        cursor: pointer;
        font-family: 'Inter', sans-serif;
        font-size: 10px;
        font-weight: 500;
        white-space: nowrap;
        flex-shrink: 0;
        transition: all 0.12s;
    }

    .spawn-btn:hover {
        background: var(--bg-hover);
        border-color: var(--glass-border-light);
        color: var(--text-bright);
    }

    .spawn-btn:active {
        background: var(--bg-active);
        border-color: var(--glass-border-cyan);
        color: var(--cyan);
        transform: scale(0.97);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CANVAS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #canvas-container {
        flex: 1;
        position: relative;
        overflow: hidden;
        background: var(--bg-deep);
        cursor: crosshair;
        z-index: 1;
    }

    canvas { width: 100%; height: 100%; display: block; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ZOOM + HUD
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #zoom-controls {
        position: absolute;
        right: 14px;
        top: 14px;
        display: flex;
        flex-direction: column;
        gap: 2px;
        z-index: 20;
        background: rgba(11,14,23,0.75);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-md);
        backdrop-filter: blur(20px);
        padding: 4px;
    }

    .zoom-btn {
        width: 30px; height: 30px;
        display: flex; align-items: center; justify-content: center;
        background: transparent;
        border: none;
        border-radius: var(--radius-sm);
        color: var(--text-mid);
        cursor: pointer;
        font-family: 'DM Mono', monospace;
        font-size: 14px;
        transition: all 0.12s;
    }

    .zoom-btn:hover { background: var(--bg-hover); color: var(--cyan); }
    .zoom-btn:active { transform: scale(0.9); }

    .zoom-divider { height: 1px; background: var(--glass-border); margin: 0 4px; }

    #hud-coords {
        position: absolute;
        left: 14px;
        top: 14px;
        font-family: 'DM Mono', monospace;
        font-size: 9px;
        color: var(--text-dim);
        letter-spacing: 0.5px;
        background: rgba(11,14,23,0.75);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-md);
        padding: 7px 12px;
        line-height: 1.8;
        backdrop-filter: blur(20px);
        pointer-events: none;
        z-index: 20;
    }

    #hud-coords span { color: var(--text-mid); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       VIRTUAL CONTROLS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #virtual-controls {
        position: relative;
        z-index: 10;
        background: rgba(11,14,23,0.85);
        backdrop-filter: blur(20px);
        border-top: 1px solid var(--glass-border);
        height: 170px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 24px;
        flex-shrink: 0;
        gap: 16px;
    }

    .dpad {
        display: grid;
        grid-template-columns: repeat(3, 46px);
        grid-template-rows: repeat(2, 46px);
        gap: 4px;
    }

    .btn-v {
        background: var(--bg-surface);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-sm);
        display: flex; align-items: center; justify-content: center;
        color: var(--text-dim);
        font-size: 13px;
        cursor: pointer;
        transition: all 0.1s;
    }

    .btn-v:active {
        background: var(--bg-active);
        border-color: var(--glass-border-cyan);
        color: var(--cyan);
    }

    .btn-up { grid-column: 2; }
    .btn-left { grid-column: 1; grid-row: 2; }
    .btn-down { grid-column: 2; grid-row: 2; }
    .btn-right { grid-column: 3; grid-row: 2; }

    .actions {
        display: grid;
        grid-template-columns: repeat(3, 54px);
        grid-template-rows: repeat(2, 54px);
        gap: 5px;
    }

    .btn-action {
        border-radius: var(--radius-sm);
        font-family: 'DM Mono', monospace;
        font-size: 8px;
        font-weight: 500;
        letter-spacing: 0.5px;
        border: 1px solid;
        cursor: pointer;
        transition: all 0.1s;
    }

    .btn-action:active { transform: scale(0.93); }

    .btn-click { background: rgba(0,230,118,0.08); border-color: rgba(0,230,118,0.25); color: var(--green); }
    .btn-del   { background: rgba(255,71,87,0.08);  border-color: rgba(255,71,87,0.25);  color: var(--red); }
    .btn-use   { background: rgba(255,183,0,0.08);  border-color: rgba(255,183,0,0.25);  color: var(--amber); }
    .btn-cfg   { background: rgba(167,139,250,0.08);border-color: rgba(167,139,250,0.25);color: var(--purple); }
    .btn-rot   { background: rgba(0,212,255,0.08);  border-color: rgba(0,212,255,0.25);  color: var(--cyan); }
    .btn-sel   { background: var(--bg-surface);     border-color: var(--glass-border);   color: var(--text-mid); }

    .btn-click:active { background: rgba(0,230,118,0.2); }
    .btn-del:active   { background: rgba(255,71,87,0.2); }
    .btn-use:active   { background: rgba(255,183,0,0.2); }
    .btn-cfg:active   { background: rgba(167,139,250,0.2); }
    .btn-rot:active   { background: rgba(0,212,255,0.2); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MODAL
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #modal {
        display: none;
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(11,14,23,0.92);
        border: 1px solid var(--glass-border-light);
        border-radius: var(--radius-lg);
        backdrop-filter: blur(40px);
        box-shadow: 0 24px 80px rgba(0,0,0,0.7), 0 0 0 1px var(--glass-border);
        z-index: 100;
        width: 320px;
        overflow: hidden;
        transition: width 0.2s ease;
    }

    #modal.code-mode {
        width: 520px;
    }

    .code-editor-wrap {
        display: none;
        flex-direction: column;
        margin-bottom: 12px;
        border: 1px solid var(--glass-border-light);
        border-radius: var(--radius-sm);
        overflow: hidden;
        background: rgba(0,0,0,0.55);
    }

    .code-toolbar {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 5px 8px;
        background: rgba(255,255,255,0.03);
        border-bottom: 1px solid var(--glass-border);
    }

    .code-toolbar-label {
        font-family: 'DM Mono', monospace;
        font-size: 9px;
        color: var(--text-dim);
        letter-spacing: 1px;
        margin-right: auto;
    }

    .code-snippet-btn {
        padding: 2px 7px;
        background: rgba(255,255,255,0.04);
        border: 1px solid var(--glass-border);
        border-radius: 3px;
        color: var(--text-dim);
        font-family: 'DM Mono', monospace;
        font-size: 8px;
        cursor: pointer;
        transition: all 0.1s;
        white-space: nowrap;
    }
    .code-snippet-btn:hover { background: var(--bg-active); border-color: var(--glass-border-cyan); color: var(--cyan); }

    .code-body {
        display: flex;
        height: 220px;
        overflow: hidden;
    }

    .code-lines {
        width: 32px;
        flex-shrink: 0;
        background: rgba(0,0,0,0.3);
        border-right: 1px solid var(--glass-border);
        padding: 10px 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        padding-right: 6px;
    }

    .line-num {
        font-family: 'DM Mono', monospace;
        font-size: 10px;
        color: var(--text-dim);
        line-height: 1.7em;
        min-height: 1.7em;
        font-weight: 300;
        opacity: 0.5;
    }

    #m-code-area {
        flex: 1;
        height: 100%;
        background: transparent;
        color: #a8d8c8;
        border: none;
        font-family: 'DM Mono', monospace;
        font-size: 11px;
        font-weight: 300;
        line-height: 1.7;
        padding: 10px 10px;
        resize: none;
        display: block;
        outline: none;
        tab-size: 2;
        caret-color: var(--cyan);
        scrollbar-width: thin;
        scrollbar-color: rgba(255,255,255,0.08) transparent;
    }

    #m-code-area::placeholder { color: var(--text-dim); }

    .code-statusbar {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 4px 10px;
        background: rgba(0,0,0,0.3);
        border-top: 1px solid var(--glass-border);
        font-family: 'DM Mono', monospace;
        font-size: 8px;
        color: var(--text-dim);
    }

    .code-status-item { display: flex; align-items: center; gap: 4px; }
    .code-status-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--green); }

    .modal-titlebar {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid var(--glass-border);
        gap: 10px;
    }

    .modal-accent {
        width: 2px; height: 14px;
        background: var(--cyan);
        border-radius: 2px;
    }

    #m-title {
        font-family: 'Syne', sans-serif;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 1.5px;
        color: var(--text-bright);
    }

    .modal-body { padding: 16px; }

    .modal-field {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        background: rgba(255,255,255,0.03);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-sm);
        margin-bottom: 12px;
    }

    #m-val {
        flex: 1;
        background: transparent;
        border: none;
        color: var(--cyan);
        font-family: 'DM Mono', monospace;
        font-size: 18px;
        font-weight: 300;
        text-align: center;
        outline: none;
        width: 80px;
    }

    #m-unit {
        font-family: 'DM Mono', monospace;
        font-size: 11px;
        color: var(--text-dim);
    }

    .modal-actions {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }

    .modal-btn {
        height: 28px;
        padding: 0 14px;
        background: var(--bg-surface);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-sm);
        color: var(--text-mid);
        cursor: pointer;
        font-family: 'Inter', sans-serif;
        font-size: 10px;
        font-weight: 500;
        letter-spacing: 0.3px;
        transition: all 0.12s;
    }

    .modal-btn:hover { background: var(--bg-hover); color: var(--text-bright); border-color: var(--glass-border-light); }

    .modal-btn-save { color: var(--cyan); border-color: rgba(0,212,255,0.25); background: var(--bg-active); }
    .modal-btn-save:hover { background: rgba(0,212,255,0.15); border-color: var(--glass-border-cyan); }

    .modal-btn-rep { color: var(--amber); border-color: rgba(255,183,0,0.25); }
    .modal-btn-rep:hover { background: rgba(255,183,0,0.1); border-color: rgba(255,183,0,0.4); }

    .modal-btn-toggle { color: var(--cyan-dim); border-color: rgba(0,136,170,0.3); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MANUAL
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #manual-screen {
        display: none;
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        width: 86%; height: 88%;
        background: rgba(11,14,23,0.96);
        border: 1px solid var(--glass-border-light);
        border-radius: var(--radius-lg);
        backdrop-filter: blur(40px);
        box-shadow: 0 32px 100px rgba(0,0,0,0.8);
        z-index: 300;
        overflow: hidden;
    }

    .manual-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 20px;
        border-bottom: 1px solid var(--glass-border);
    }

    .manual-title-wrap { display: flex; align-items: center; gap: 10px; }

    .manual-title {
        font-family: 'Syne', sans-serif;
        font-size: 13px;
        font-weight: 700;
        letter-spacing: 2px;
        color: var(--text-bright);
    }

    .manual-badge {
        font-family: 'DM Mono', monospace;
        font-size: 8px;
        color: var(--amber);
        border: 1px solid rgba(255,183,0,0.3);
        border-radius: 3px;
        padding: 1px 6px;
        letter-spacing: 1px;
    }

    .close-manual {
        height: 26px;
        padding: 0 12px;
        background: var(--red-dim);
        border: 1px solid rgba(255,71,87,0.25);
        border-radius: var(--radius-sm);
        color: var(--red);
        cursor: pointer;
        font-family: 'Inter', sans-serif;
        font-size: 10px;
        font-weight: 500;
        transition: all 0.12s;
    }

    .close-manual:hover { background: rgba(255,71,87,0.2); border-color: rgba(255,71,87,0.45); }

    .manual-inner {
        height: calc(100% - 56px);
        overflow-y: auto;
        padding: 24px 28px;
    }

    .manual-inner::-webkit-scrollbar { width: 3px; }
    .manual-inner::-webkit-scrollbar-track { background: transparent; }
    .manual-inner::-webkit-scrollbar-thumb { background: var(--glass-border-light); border-radius: 2px; }

    #manual-screen h4 {
        font-family: 'Syne', sans-serif;
        font-size: 10px;
        font-weight: 700;
        letter-spacing: 2px;
        color: var(--cyan);
        margin: 22px 0 10px;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    #manual-screen h4::before {
        content: '';
        width: 16px; height: 1px;
        background: var(--cyan);
        opacity: 0.5;
    }

    #manual-screen p, #manual-screen li {
        font-family: 'Inter', sans-serif;
        font-size: 12px;
        line-height: 1.9;
        color: var(--text-mid);
        font-weight: 300;
    }

    #manual-screen strong { color: var(--text-bright); font-weight: 500; }
    #manual-screen ul { padding-left: 16px; }

    #manual-screen pre {
        background: rgba(0,0,0,0.5);
        border: 1px solid var(--glass-border);
        border-left: 2px solid rgba(255,183,0,0.4);
        border-radius: var(--radius-sm);
        padding: 12px 14px;
        color: #a3c4a3;
        font-family: 'DM Mono', monospace;
        font-size: 11px;
        font-weight: 300;
        overflow-x: auto;
        margin: 10px 0;
    }

    #manual-screen code {
        background: rgba(0,212,255,0.07);
        border: 1px solid rgba(0,212,255,0.15);
        border-radius: 3px;
        padding: 1px 5px;
        color: var(--cyan);
        font-family: 'DM Mono', monospace;
        font-size: 10.5px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CONTEXT MENU
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #context-menu {
        display: none;
        position: absolute;
        background: rgba(11,14,23,0.95);
        border: 1px solid var(--glass-border-light);
        border-radius: var(--radius-md);
        backdrop-filter: blur(30px);
        box-shadow: 0 12px 40px rgba(0,0,0,0.7);
        z-index: 200;
        min-width: 150px;
        overflow: hidden;
    }

    .ctx-section {
        padding: 6px 8px 2px;
        font-family: 'DM Mono', monospace;
        font-size: 8px;
        color: var(--text-dim);
        letter-spacing: 1.5px;
    }

    .ctx-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 7px 12px;
        color: var(--text-mid);
        cursor: pointer;
        font-family: 'Inter', sans-serif;
        font-size: 12px;
        font-weight: 400;
        transition: all 0.1s;
    }

    .ctx-item:hover { background: var(--bg-hover); color: var(--text-bright); }

    .ctx-icon {
        width: 14px; text-align: center;
        font-size: 11px;
        color: var(--text-dim);
    }

    .ctx-item:hover .ctx-icon { color: var(--cyan); }

    .ctx-item.danger:hover { background: var(--red-dim); color: var(--red); }
    .ctx-item.danger:hover .ctx-icon { color: var(--red); }

    .ctx-separator { height: 1px; background: var(--glass-border); margin: 3px 0; }

    /* Desktop mode */
    .desktop-mode #virtual-controls { display: none !important; }
    .desktop-mode #zoom-controls { top: auto; bottom: 16px; right: 16px; }

    #about-screen {
        display: none;
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        width: 60%; max-width: 540px;
        height: auto; max-height: 80%;
        background: rgba(11,14,23,0.96);
        border: 1px solid var(--glass-border-light);
        border-radius: var(--radius-lg);
        backdrop-filter: blur(40px);
        box-shadow: 0 32px 100px rgba(0,0,0,0.8);
        z-index: 300;
        overflow: hidden;
    }
</style>
```

</head>
<body>

<!-- HEADER -->

<div id="header">
    <div class="logo-wrap">
        <div class="logo-icon">SP</div>
        <span class="logo-text">SIMULIC</span>
        <span class="logo-version">v1.8 Â· I2C-OLED</span>
    </div>
    <div class="header-divider"></div>
    <div class="status-pill">
        <div class="status-dot"></div>
        <span class="status-label">SIMULATION ACTIVE</span>
    </div>
    <div class="header-right">
        <button class="hdr-btn hdr-btn-mode" onclick="toggleMode()" id="btnMode">ğŸ“± Mobile</button>
        <button class="hdr-btn hdr-btn-danger" onclick="clearAll()">Clear All</button>
    </div>
</div>

<!-- NAV TABS -->

<div id="ui-top">
    <div class="cat-group">
        <button class="cat-btn" onclick="selectCategory('active', this)">Activos</button>
        <button class="cat-btn" onclick="selectCategory('passive', this)">Pasivos</button>
        <button class="cat-btn" onclick="selectCategory('digital', this)">Digitales</button>
        <button class="cat-btn" onclick="selectCategory('boards', this)">Placas</button>
        <button class="cat-btn" onclick="selectCategory('output_plus', this)">Output+</button>
        <button class="cat-btn" onclick="selectCategory('dev_plus', this)" style="color:rgba(167,139,250,0.6);">Dev+</button>
    </div>
    <div class="cat-group">
        <button class="cat-btn cat-btn-demo" onclick="selectCategory('demos', this)">â˜… Demos</button>
        <button class="cat-btn cat-btn-manual" onclick="toggleManual()">Manual</button>
        <button class="cat-btn cat-btn-manual" onclick="toggleAbout()">About</button>
    </div>
</div>

<!-- SPAWN BAR -->

<div id="ui-sub">
    <span class="sub-hint">â†‘ Selecciona una categorÃ­a</span>
</div>

<div id="canvas-container" oncontextmenu="return false;">

```
<div id="hud-coords">
    <div>X <span id="cx">0</span></div>
    <div>Y <span id="cy">0</span></div>
    <div>Z <span id="cz">1.0</span>Ã—</div>
</div>

<div id="zoom-controls">
    <button class="zoom-btn" onclick="camera.zoom = Math.min(3.0, camera.zoom + 0.2)" title="Zoom In">+</button>
    <div class="zoom-divider"></div>
    <button class="zoom-btn" onclick="camera.zoom = 1.0" style="font-size:9px; letter-spacing:-0.5px;" title="Reset">1:1</button>
    <div class="zoom-divider"></div>
    <button class="zoom-btn" onclick="camera.zoom = Math.max(0.4, camera.zoom - 0.2)" title="Zoom Out">âˆ’</button>
</div>

<canvas id="circuitCanvas"></canvas>

<!-- MODAL -->
<div id="modal">
    <div class="modal-titlebar">
        <div class="modal-accent"></div>
        <div id="m-title">CONFIGURE</div>
        <div id="m-lang-badge" style="display:none; margin-left:auto; font-family:'DM Mono',monospace; font-size:8px; color:var(--cyan); border:1px solid rgba(0,212,255,0.25); padding:1px 7px; border-radius:3px; letter-spacing:1px;">LOG v1.1</div>
    </div>
    <div class="modal-body">
        <div class="modal-field" id="m-val-row">
            <input type="number" id="m-val">
            <span id="m-unit"></span>
        </div>

        <!-- PROFESSIONAL CODE EDITOR -->
        <div class="code-editor-wrap" id="m-code-editor">
            <div class="code-toolbar">
                <span class="code-toolbar-label">RADION 1.1 Â· LOG EDITOR</span>
                <button class="code-snippet-btn" onclick="insertSnippet('loop')">loop{}</button>
                <button class="code-snippet-btn" onclick="insertSnippet('delay')">delay</button>
                <button class="code-snippet-btn" onclick="insertSnippet('if')">if</button>
                <button class="code-snippet-btn" onclick="insertSnippet('oled')">oled</button>
            </div>
            <div class="code-body">
                <div class="code-lines" id="m-line-nums"></div>
                <textarea id="m-code-area" spellcheck="false" placeholder="// LOG code..." oninput="syncLineNums()" onscroll="syncLineScroll()"></textarea>
            </div>
            <div class="code-statusbar">
                <div class="code-status-item"><div class="code-status-dot"></div><span>LOG v1.1</span></div>
                <div class="code-status-item"><span id="m-line-count">0 lÃ­neas</span></div>
                <div class="code-status-item"><span id="m-char-count">0 chars</span></div>
            </div>
        </div>

        <div class="modal-actions">
            <button class="modal-btn modal-btn-toggle" id="m-toggle" onclick="toggleCompType()" style="display:none;">TYPE: NPN</button>
            <button class="modal-btn modal-btn-save" onclick="saveCfg()">Save</button>
            <button class="modal-btn" onclick="closeCfg()">Cancel</button>
            <button class="modal-btn modal-btn-rep" id="m-repair" onclick="repairCfg()" style="display:none;">Repair</button>
        </div>
    </div>
</div>

<!-- MANUAL -->
<div id="manual-screen">
    <div class="manual-header">
        <div class="manual-title-wrap">
            <span class="manual-title">MANUAL</span>
            <span class="manual-badge">SIMULIC PRO</span>
        </div>
        <button class="close-manual" onclick="toggleManual()">Cerrar âœ•</button>
    </div>
    <div class="manual-inner">
        <h4>IntroducciÃ³n</h4>
        <p>Bienvenido a Simulic Pro, un entorno de simulaciÃ³n electrÃ³nica donde la fÃ­sica importa. AquÃ­ puedes crear circuitos complejos, lÃ³gica digital y automatizaciÃ³n.</p>

        <h4>Â¿Por quÃ© se queman mis componentes?</h4>
        <p style="color:var(--red);">Esto no es un error â€” es fÃ­sica.</p>
        <p>Al igual que en la vida real, los componentes tienen lÃ­mites:</p>
        <ul>
            <li>Un <strong>LED</strong> conectado directo a una baterÃ­a de 9V <strong>explotarÃ¡</strong>. Necesita una resistencia (aprox 330Î©).</li>
            <li>Un <strong>Transistor</strong> sin resistencia en la base se quemarÃ¡.</li>
            <li>Si algo dice "BURNED", usa <strong>Ajustar â†’ Reparar</strong>.</li>
        </ul>

        <h4>ProgramaciÃ³n LOG (Radion 1.1)</h4>
        <p>El componente RADION cuenta con pines D1, D2, D3 y un bus I2C (SCL, SDA).</p>
        <ul>
            <li><code>start&lt;</code> / <code>end&gt;</code> â€” Delimitan el programa.</li>
            <li><code>var=D1</code> â€” Asigna pin fÃ­sico a variable.</li>
            <li><code>var;HIGH</code> / <code>var;LOW</code> â€” Controla salida digital.</li>
            <li><code>delay 500</code> â€” Espera en milisegundos.</li>
            <li><code>loop{ ... }</code> â€” Bucle infinito.</li>
            <li><code>if var==HIGH { ... }</code> â€” Condicional de entrada.</li>
        </ul>

        <h4>Variables NumÃ©ricas y AritmÃ©tica</h4>
        <p>Puedes declarar variables numÃ©ricas, operar con ellas y usarlas en condiciones:</p>
        <ul>
            <li><code>contador=0</code> â€” Variable numÃ©rica.</li>
            <li><code>contador=contador+1</code> â€” Suma, resta, multiplicaciÃ³n, divisiÃ³n, mÃ³dulo.</li>
            <li><code>if contador &gt; 5 { ... }</code> â€” Comparaciones: <code>&gt;</code> <code>&lt;</code> <code>&gt;=</code> <code>&lt;=</code> <code>==</code> <code>!=</code></li>
            <li><code>oled.print contador</code> â€” Muestra el valor de una variable en pantalla.</li>
            <li><code>pin1;HIGH if contador &gt; 0</code> â€” Activar pin con condiciÃ³n inline.</li>
            <li><code>delay velocidad</code> â€” Usar variable numÃ©rica como tiempo de delay.</li>
        </ul>
        <pre>start&lt;
```

pin1=D1
pinBtn=D2
contador=0
velocidad=300
oled.init
oled.println â€œRADION 1.1â€
loop{
pinBtn=D2
if pinBtn==HIGH {
contador=contador+1
pin1;HIGH
delay 100
pin1;LOW
}
if contador > 9 {
contador=0
oled.clear
oled.println â€œRESET!â€
}
oled.clear
oled.print â€œCOUNT: â€œ
oled.print contador
delay velocidad
}
end></pre>

```
        <h4>Pantallas OLED (I2C)</h4>
        <p>Conecta SCLâ†’SCL y SDAâ†’SDA entre Radion y OLED (+ alimentaciÃ³n). Luego:</p>
        <ul>
            <li><code>oled.init</code> â€” Inicializa la pantalla.</li>
            <li><code>oled.print "Texto"</code> â€” Escribe en lÃ­nea actual.</li>
            <li><code>oled.print variable</code> â€” Muestra valor de variable (numÃ©rica o string).</li>
            <li><code>oled.println "Texto"</code> â€” Escribe y salta a nueva lÃ­nea.</li>
            <li><code>oled.clear</code> â€” Limpia la pantalla.</li>
        </ul>
    </div>
</div>

<!-- ABOUT -->
<div id="about-screen">
    <div class="manual-header">
        <div class="manual-title-wrap">
            <span class="manual-title">ABOUT</span>
            <span class="manual-badge">SIMULIC PRO</span>
        </div>
        <button class="close-manual" onclick="toggleAbout()">Cerrar âœ•</button>
    </div>
    <div class="manual-inner">
        <h4>What is Simulic Pro?</h4>
        <p>Simulic Pro is a browser-based electronics circuit simulator built for learning, prototyping, and experimentation. No installations, no dependencies â€” just open it and start building.</p>
        <p>It features a real physics engine that simulates voltage, current, and component limits, meaning components actually burn if you wire them wrong. This is intentional â€” it's how you learn.</p>

        <h4>What can it do?</h4>
        <p>Beyond basic circuits, Simulic Pro includes the <strong>Radion 1.1</strong>, a programmable microcontroller board with its own scripting language called <strong>LOG</strong>. With it you can control digital pins, run loops and conditionals, work with numeric variables, perform arithmetic, and drive I2C OLED displays â€” all inside the simulator.</p>

        <h4>From the developer</h4>
        <p>Hi! Simulic Pro is a solo project, built and maintained by a single developer. Every feature, fix, and improvement comes from genuine passion for making electronics more accessible and fun to learn.</p>
        <p>If you enjoy using it and would like to contribute â€” whether that's ideas, feedback, bug reports, or collaboration â€” you're more than welcome to reach out. The official contact email is listed on the <strong>GitHub repository</strong>.</p>
        <p style="margin-top: 16px; color: var(--cyan); font-family: 'DM Mono', monospace; font-size: 13px; letter-spacing: 1px;">Thank you for your support! ğŸ’™</p>
    </div>
</div>

<!-- CONTEXT MENU -->
<div id="context-menu">
    <div class="ctx-section">ACTIONS</div>
    <div class="ctx-item" onclick="ctxAction('use')"><span class="ctx-icon">â–¶</span>Usar</div>
    <div class="ctx-item" onclick="ctxAction('cfg')"><span class="ctx-icon">âš™</span>Ajustar</div>
    <div class="ctx-item" onclick="ctxAction('rot')"><span class="ctx-icon">â†»</span>Rotar</div>
    <div class="ctx-separator"></div>
    <div class="ctx-item danger" onclick="ctxAction('del')"><span class="ctx-icon">âœ•</span>Borrar</div>
</div>
```

</div>

<!-- VIRTUAL CONTROLS -->

<div id="virtual-controls">
    <div class="dpad">
        <div class="btn-v btn-up" id="vUp">â–²</div>
        <div class="btn-v btn-left" id="vLeft">â—€</div>
        <div class="btn-v btn-down" id="vDown">â–¼</div>
        <div class="btn-v btn-right" id="vRight">â–¶</div>
    </div>
    <div class="actions">
        <button class="btn-action btn-click" id="vClick">CABLE</button>
        <button class="btn-action btn-use"   id="vUse">USAR</button>
        <button class="btn-action btn-rot"   id="vRot">ROTAR</button>
        <button class="btn-action btn-cfg"   id="vCfg">AJUSTAR</button>
        <button class="btn-action btn-del"   id="vDel">BORRAR</button>
        <button class="btn-action btn-sel"   id="vSel">SELECT</button>
    </div>
</div>

<script>
    let isDesktopMode = false;

    function toggleMode() {
        isDesktopMode = !isDesktopMode;
        const body = document.body;
        const btn = document.getElementById('btnMode');
        if (isDesktopMode) {
            body.classList.add('desktop-mode');
            btn.innerText = "ğŸ–¥ï¸ Desktop";
            btn.style.color = "#00e676";
        } else {
            body.classList.remove('desktop-mode');
            btn.innerText = "ğŸ“± Mobile";
            btn.style.color = "";
        }
        resize();
    }

    function toggleManual() {
        const m = document.getElementById('manual-screen');
        m.style.display = (m.style.display === 'block') ? 'none' : 'block';
    }

    function toggleAbout() {
        const m = document.getElementById('about-screen');
        m.style.display = (m.style.display === 'block') ? 'none' : 'block';
    }

    const componentLists = {
        'active': [
            { id: 'BATTERY', label: 'BaterÃ­a' }, { id: 'LED', label: 'LED' },
            { id: 'MOTOR', label: 'Motor' }, { id: 'TRANSISTOR', label: 'Transistor' }, { id: 'RELAY', label: 'RelÃ©' }
        ],
        'passive': [
            { id: 'SWITCH', label: 'Interruptor' }, { id: 'PUSH_BTN', label: 'BotÃ³n' },
            { id: 'RESISTOR', label: 'Resistencia' }, { id: 'CAPACITOR', label: 'Condensador' }
        ],
        'digital': [
            { id: 'RSK90', label: 'Chip RSK90' }, { id: 'AND', label: 'AND' }, { id: 'OR', label: 'OR' },
            { id: 'XOR', label: 'XOR' }, { id: 'NOT', label: 'NOT' }, { id: 'MUX', label: 'MUX' }
        ],
        'boards': [{ id: 'RADION', label: 'Radion 1.1' }],
        'output_plus': [{ id: 'OLED_I2C', label: 'OLED Display' }],
        'dev_plus': [{ id: 'L298N', label: 'L298N Motor Driver' }]
    };

    const demos = {
        'EMPTY':  { label: 'VacÃ­o', func: () => clearAll(true) },
        'BASIC':  { label: 'Electricidad BÃ¡sica', func: () => loadBasicDemo() },
        'LOGIC':  { label: 'Puerta AND', func: () => loadLogicDemo() },
        'MOTOR':  { label: 'Control Motor', func: () => loadMotorDemo() },
        'RADION': { label: 'Radion Blink', func: () => loadRadionDemo() },
        'INPUT':  { label: 'Radion Input', func: () => loadInputDemo() },
        'OLED':   { label: 'Radion OLED', func: () => loadOledDemo() },
        'MDRIVER':{ label: 'Radion + L298N', func: () => loadMotorDriverDemo() }
    };

    function selectCategory(cat, btnElement) {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        if (btnElement && !btnElement.classList.contains('cat-btn-manual')) btnElement.classList.add('active');
        const sub = document.getElementById('ui-sub');
        sub.innerHTML = '';

        if (cat === 'demos') {
            Object.keys(demos).forEach(key => {
                const d = demos[key];
                const btn = document.createElement('button');
                btn.className = 'spawn-btn';
                btn.innerText = d.label;
                btn.style.color = key === 'EMPTY' ? 'var(--red)' : 'var(--purple)';
                btn.style.borderColor = key === 'EMPTY' ? 'rgba(255,71,87,0.25)' : 'rgba(167,139,250,0.25)';
                btn.onclick = d.func;
                sub.appendChild(btn);
            });
        } else {
            componentLists[cat].forEach(comp => {
                const btn = document.createElement('button');
                btn.className = 'spawn-btn';
                btn.innerText = comp.label;
                btn.onclick = () => spawn(comp.id);
                if (cat === 'digital') btn.style.color = 'var(--cyan)';
                if (comp.id === 'RADION') { btn.style.color = 'var(--green)'; btn.style.borderColor = 'rgba(0,230,118,0.3)'; }
                if (comp.id === 'OLED_I2C') { btn.style.color = 'var(--amber)'; btn.style.borderColor = 'rgba(255,183,0,0.3)'; }
                if (comp.id === 'L298N') { btn.style.color = 'var(--purple)'; btn.style.borderColor = 'rgba(167,139,250,0.3)'; }
                sub.appendChild(btn);
            });
        }
    }

    function connect(c1, pin1, c2, pin2) {
        const n1 = c1.nodes[pin1], n2 = c2.nodes[pin2];
        if (n1 && n2) connections.push({ a: {c:c1, n:n1}, b: {c:c2, n:n2} });
    }

    function loadBasicDemo() {
        clearAll(true); camera.x = 0; camera.y = 0; camera.zoom = 1.0;
        const bat = spawn('BATTERY', -150, -50); const res = spawn('RESISTOR', -20, -100);
        const sw = spawn('SWITCH', -20, 0); const led = spawn('LED', 120, -50);
        connect(bat,0,res,0); connect(res,1,led,0); connect(led,1,sw,1); connect(sw,0,bat,1); sw.closed = true;
    }

    function loadLogicDemo() {
        clearAll(true); camera.x = 0; camera.y = 0;
        const sw1 = spawn('SWITCH', -180, -80); const sw2 = spawn('SWITCH', -180, 20);
        const andGate = spawn('AND', -30, -30); const res = spawn('RESISTOR', 100, -30); res.val = 220;
        const led = spawn('LED', 200, -30); const bat = spawn('BATTERY', -250, 150);
        connect(bat,0,sw1,0); connect(bat,0,sw2,0); connect(sw1,1,andGate,0); connect(sw2,1,andGate,1);
        connect(andGate,2,res,0); connect(res,1,led,0); connect(led,1,bat,1);
    }

    function loadMotorDemo() {
        clearAll(true); camera.x = 0; camera.y = 0; camera.zoom = 1.0;
        const bat = spawn('BATTERY',-120,-50); const res = spawn('RESISTOR',-20,-120); res.val=10;
        const btn = spawn('PUSH_BTN',60,-50); const motor = spawn('MOTOR',60,50);
        connect(bat,0,res,0); connect(res,1,motor,0); connect(motor,1,btn,0); connect(btn,1,bat,1);
    }

    function loadRadionDemo() {
        clearAll(true); camera.x = 0; camera.y = 0; camera.zoom = 1.0;
        const radion = spawn('RADION',-50,-50); const led1 = spawn('LED',150,-80);
        const led2 = spawn('LED',150,20); const bat = spawn('BATTERY',-200,0);
        connect(bat,0,radion,0); connect(bat,1,radion,1); connect(radion,3,led1,0);
        connect(led1,1,radion,2); connect(radion,4,led2,0); connect(led2,1,radion,2);
        radion.code = `start<\npin1=D1\npin2=D2\nloop{\n  pin1;HIGH\n  delay 200\n  pin1;LOW\n  pin2;HIGH\n  delay 200\n  pin2;LOW\n}\nend>`;
        radion.intState = { pc:0, wait:0, vars:{}, parsed:null };
    }

    function loadInputDemo() {
        clearAll(true); camera.x = 0; camera.y = 0; camera.zoom = 1.0;
        const radion = spawn('RADION',-20,-50); const led = spawn('LED',150,-20);
        const btn = spawn('PUSH_BTN',-180,20); const bat = spawn('BATTERY',-250,-100);
        connect(bat,0,radion,0); connect(bat,1,radion,1); connect(bat,0,btn,0);
        connect(btn,1,radion,4); connect(radion,3,led,0); connect(led,1,radion,2);
        radion.code = `start<\npinLed=D1\npinBtn=D2\nloop{\n  if pinBtn==HIGH {\n    pinLed;HIGH\n  }\n  if pinBtn==LOW {\n    pinLed;LOW\n  }\n}\nend>`;
        radion.intState = { pc:0, wait:0, vars:{}, parsed:null };
    }

    function loadOledDemo() {
        clearAll(true); camera.x = 0; camera.y = 0; camera.zoom = 1.0;
        const radion = spawn('RADION',-100,-30); const oled = spawn('OLED_I2C',100,-30);
        const bat = spawn('BATTERY',-260,-30);
        connect(bat,0,radion,0); connect(bat,1,radion,1); connect(bat,0,oled,0); connect(bat,1,oled,1);
        connect(radion,6,oled,2); connect(radion,7,oled,3);
        radion.code = `start<\noled.init\noled.println "HELLO WORLD!"\ndelay 1000\noled.println "RADION 1.1 I2C"\ndelay 1000\noled.println "STATUS: OK"\nloop{\n  delay 500\n  oled.print "."\n}\nend>`;
        radion.intState = { pc:0, wait:0, vars:{}, parsed:null };
    }

    function loadMotorDriverDemo() {
        clearAll(true); camera.x = 0; camera.y = 0; camera.zoom = 1.0;
        const bat    = spawn('BATTERY',   -260,  20);
        const radion = spawn('RADION',     -80, -60);
        const btn    = spawn('PUSH_BTN',  -260, -80);
        const driver = spawn('L298N',       80,  -20);
        const motor  = spawn('MOTOR',      290,  20);
        // AlimentaciÃ³n Radion desde baterÃ­a
        connect(bat,0,radion,0); connect(bat,1,radion,1);
        // BotÃ³n â†’ D3 (entrada digital)
        connect(bat,0,btn,0); connect(btn,1,radion,5);
        // Radion D1 â†’ IN1, D2 â†’ IN2 (seÃ±ales de control)
        connect(radion,3,driver,2); connect(radion,4,driver,3);
        // AlimentaciÃ³n driver desde baterÃ­a
        connect(bat,0,driver,0); connect(bat,1,driver,1);
        // Tierra comÃºn: GND driver ya comparte bat- con GND Radion
        // Motor entre OUT1 y OUT2 del driver (puente H)
        connect(driver,4,motor,0); connect(driver,5,motor,1);
        radion.code = `start<\npinBtn=D3\npin1=D1\npin2=D2\nloop{\n  pinBtn=D3\n  if pinBtn==HIGH {\n    pin1;HIGH\n    pin2;LOW\n  }\n  if pinBtn==LOW {\n    pin1;LOW\n    pin2;HIGH\n  }\n}\nend>`;
        radion.intState = { pc:0, wait:0, vars:{}, parsed:null };
    }

    selectCategory('active', document.querySelector('.cat-btn'));

    // â”€â”€â”€ ENGINE â”€â”€â”€
    const canvas = document.getElementById('circuitCanvas');
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('canvas-container');
    let components = [], connections = [];
    const vMouse = { x:0, y:0, speed:4, isDown:false, lastDown:false, moving:{}, selectionMode:false };
    let draggingComp=null, drawingCable=null, rotAnim=0, time=0;
    let targetCfg=null, selectionBox=null, selectedItems=[], camera={x:0,y:0,zoom:1.0};
    let contextTarget=null, isPanning=false;

    function resize() { canvas.width = container.clientWidth; canvas.height = container.clientHeight; }
    window.addEventListener('resize', resize); resize();

    canvas.addEventListener('wheel', (e) => {
        if (!isDesktopMode) return;
        e.preventDefault();
        camera.zoom = Math.min(3.0, Math.max(0.4, camera.zoom + Math.sign(e.deltaY)*-0.1));
    });

    canvas.addEventListener('mousemove', (e) => {
        if (!isDesktopMode) return;
        if (isPanning) { camera.x -= e.movementX/camera.zoom; camera.y -= e.movementY/camera.zoom; return; }
        const rect = canvas.getBoundingClientRect();
        vMouse.x = ((e.clientX - rect.left)/camera.zoom) + camera.x - (canvas.width/2)/camera.zoom;
        vMouse.y = ((e.clientY - rect.top)/camera.zoom) + camera.y - (canvas.height/2)/camera.zoom;
        if (selectionBox) { selectionBox.w = vMouse.x - selectionBox.x; selectionBox.h = vMouse.y - selectionBox.y; }
    });

    canvas.addEventListener('mousedown', (e) => {
        if (!isDesktopMode) return;
        if (e.button === 1) { e.preventDefault(); isPanning = true; canvas.style.cursor = 'grabbing'; return; }
        if (e.button !== 0) return;
        document.getElementById('context-menu').style.display = 'none';
        let nHit = null;
        components.forEach(c => c.nodes.forEach(n => { if (Math.hypot(c.x+n.x-vMouse.x, c.y+n.y-vMouse.y) < 20) nHit = {c,n}; }));
        if (nHit) { drawingCable = nHit; }
        else {
            let compHit = components.find(c => vMouse.x>c.x && vMouse.x<c.x+c.w && vMouse.y>c.y && vMouse.y<c.y+c.h);
            if (compHit) {
                if (selectedItems.includes(compHit)) draggingComp = {group:true, ref:compHit, ox:vMouse.x, oy:vMouse.y};
                else { selectedItems.forEach(c=>c.selected=false); selectedItems=[]; draggingComp={c:compHit,ox:vMouse.x-compHit.x,oy:vMouse.y-compHit.y}; }
            } else { selectedItems.forEach(c=>c.selected=false); selectedItems=[]; selectionBox={x:vMouse.x,y:vMouse.y,w:0,h:0}; }
        }
    });

    canvas.addEventListener('contextmenu', (e) => {
        if (!isDesktopMode) return;
        e.preventDefault();
        let compHit = components.find(c => vMouse.x>c.x && vMouse.x<c.x+c.w && vMouse.y>c.y && vMouse.y<c.y+c.h);
        if (compHit) {
            contextTarget = compHit;
            const menu = document.getElementById('context-menu');
            menu.style.display = 'block'; menu.style.left = e.clientX+'px'; menu.style.top = e.clientY+'px';
        } else document.getElementById('context-menu').style.display = 'none';
    });

    canvas.addEventListener('mouseup', (e) => {
        if (!isDesktopMode) return;
        if (e.button === 1) { isPanning = false; canvas.style.cursor = 'crosshair'; return; }
        if (drawingCable) {
            let targetHit = null;
            components.forEach(c => c.nodes.forEach(n => { if (c!==drawingCable.c && Math.hypot(c.x+n.x-vMouse.x,c.y+n.y-vMouse.y)<20) targetHit={c,n}; }));
            if (targetHit) connections.push({a:drawingCable,b:targetHit});
            else { const wp=spawn('WAYPOINT'); connections.push({a:drawingCable,b:{c:wp,n:wp.nodes[0]}}); }
        }
        if (selectionBox) { applySelection(); selectionBox=null; }
        draggingComp = drawingCable = null;
    });

    function ctxAction(action) {
        document.getElementById('context-menu').style.display = 'none';
        if (!contextTarget) return;
        if (action==='del') {
            components = components.filter(c=>c!==contextTarget);
            connections = connections.filter(conn=>components.includes(conn.a.c)&&components.includes(conn.b.c));
            if (selectedItems.includes(contextTarget)) selectedItems=[];
        } else if (action==='rot') rotateComponent(contextTarget);
        else if (action==='cfg') openCfg(contextTarget);
        else if (action==='use' && (contextTarget.type==='SWITCH'||contextTarget.type==='PUSH_BTN')) contextTarget.closed = !contextTarget.closed;
        contextTarget = null;
    }

    const bind = (id,k) => {
        const el=document.getElementById(id);
        const set=(v)=>{ if(isDesktopMode)return; vMouse.moving[k]=v; };
        el.addEventListener('touchstart',(e)=>{e.preventDefault();set(true);},{passive:false});
        el.addEventListener('touchend',(e)=>{e.preventDefault();set(false);});
        el.addEventListener('touchcancel',()=>set(false));
        el.addEventListener('mousedown',()=>set(true));
        el.addEventListener('mouseup',()=>set(false));
        el.addEventListener('mouseleave',()=>set(false));
    };
    bind('vUp','up'); bind('vDown','down'); bind('vLeft','left'); bind('vRight','right');

    const clearAllMovement = () => { vMouse.moving = {}; };
    document.addEventListener('visibilitychange', clearAllMovement);
    document.getElementById('virtual-controls').addEventListener('touchend', (e)=>{
        if(e.touches.length === 0) clearAllMovement();
    });
    document.getElementById('virtual-controls').addEventListener('touchcancel', clearAllMovement);
    window.addEventListener('blur', clearAllMovement);

    const setupBtn = (id,fn) => {
        const el=document.getElementById(id);
        el.addEventListener('mousedown',()=>{if(!isDesktopMode)fn(true);}); el.addEventListener('mouseup',()=>{if(!isDesktopMode)fn(false);});
        el.addEventListener('touchstart',(e)=>{if(!isDesktopMode){e.preventDefault();fn(true);}}); el.addEventListener('touchend',(e)=>{if(!isDesktopMode){e.preventDefault();fn(false);}});
    };
    setupBtn('vClick',(v)=>vMouse.isDown=v);
    setupBtn('vSel',(v)=>{
        vMouse.selectionMode=v;
        if(v){selectionBox={x:vMouse.x,y:vMouse.y,w:0,h:0};}
        else{if(selectionBox&&Math.abs(selectionBox.w)>5)applySelection();selectionBox=null;}
    });

    function clearAll(force=false) {
        if(force||confirm("Â¿Borrar todo?")) { components=[]; connections=[]; selectedItems=[]; drawingCable=null; }
    }

    function applySelection() {
        if(!selectionBox)return;
        let bx=selectionBox.w>0?selectionBox.x:selectionBox.x+selectionBox.w;
        let by=selectionBox.h>0?selectionBox.y:selectionBox.y+selectionBox.h;
        let bw=Math.abs(selectionBox.w); let bh=Math.abs(selectionBox.h);
        components.filter(c=>c.x+c.w>bx&&c.x<bx+bw&&c.y+c.h>by&&c.y<by+bh).forEach(c=>{if(!selectedItems.includes(c)){c.selected=true;selectedItems.push(c);}});
    }

    function distToSegment(p,v,w) {
        const l2=(w.x-v.x)**2+(w.y-v.y)**2;
        if(l2===0)return Math.hypot(p.x-v.x,p.y-v.y);
        let t=((p.x-v.x)*(w.x-v.x)+(p.y-v.y)*(w.y-v.y))/l2;
        t=Math.max(0,Math.min(1,t));
        return Math.hypot(p.x-(v.x+t*(w.x-v.x)),p.y-(v.y+t*(w.y-v.y)));
    }

    document.getElementById('vDel').addEventListener('click',()=>{
        if(selectedItems.length>0){
            components=components.filter(c=>!selectedItems.includes(c));
            connections=connections.filter(conn=>components.includes(conn.a.c)&&components.includes(conn.b.c));
            selectedItems=[];return;
        }
        let cableDeleted=false;
        connections=connections.filter(conn=>{
            if(cableDeleted)return true;
            const p1={x:conn.a.c.x+conn.a.n.x,y:conn.a.c.y+conn.a.n.y};
            const p2={x:conn.b.c.x+conn.b.n.x,y:conn.b.c.y+conn.b.n.y};
            if(distToSegment(vMouse,p1,p2)<10){cableDeleted=true;return false;}
            return true;
        });
        if(!cableDeleted){
            components=components.filter(c=>!(vMouse.x>c.x&&vMouse.x<c.x+c.w&&vMouse.y>c.y&&vMouse.y<c.y+c.h));
            connections=connections.filter(conn=>components.includes(conn.a.c)&&components.includes(conn.b.c));
        }
    });

    document.getElementById('vRot').addEventListener('click',()=>{
        if(selectedItems.length>0){selectedItems.forEach(c=>{if(c.type!=='WAYPOINT')rotateComponent(c);});}
        else{const hit=components.find(c=>vMouse.x>c.x&&vMouse.x<c.x+c.w&&vMouse.y>c.y&&vMouse.y<c.y+c.h);if(hit&&hit.type!=='WAYPOINT')rotateComponent(hit);}
    });

    function rotateComponent(c) {
        c.rotation=(c.rotation+1)%4;
        const cx=c.w/2, cy=c.h/2;
        c.nodes.forEach(n=>{const dx=n.x-cx,dy=n.y-cy;n.x=cx-dy;n.y=cy+dx;});
        [c.w,c.h]=[c.h,c.w];
    }

    const vUseBtn=document.getElementById('vUse');
    const handleUse=(active)=>{
        components.filter(c=>c.type==='PUSH_BTN').forEach(c=>{
            if(vMouse.x>c.x&&vMouse.x<c.x+c.w&&vMouse.y>c.y&&vMouse.y<c.y+c.h)c.closed=active;
            if(!active)c.closed=false;
        });
        if(active){components.forEach(c=>{if(c.type==='SWITCH'&&vMouse.x>c.x&&vMouse.x<c.x+c.w&&vMouse.y>c.y&&vMouse.y<c.y+c.h)c.closed=!c.closed;});}
    };
    vUseBtn.addEventListener('mousedown',()=>handleUse(true)); vUseBtn.addEventListener('mouseup',()=>handleUse(false));
    vUseBtn.addEventListener('touchstart',(e)=>{e.preventDefault();handleUse(true);}); vUseBtn.addEventListener('touchend',(e)=>{e.preventDefault();handleUse(false);});

    document.getElementById('vCfg').addEventListener('click',()=>{
        if(selectedItems.length>1)return;
        const hit=components.find(c=>vMouse.x>c.x&&vMouse.x<c.x+c.w&&vMouse.y>c.y&&vMouse.y<c.y+c.h);
        if(hit)openCfg(hit);
    });

    // â”€â”€ CODE EDITOR HELPERS â”€â”€
    function syncLineNums() {
        const ta = document.getElementById('m-code-area');
        const ln = document.getElementById('m-line-nums');
        const lines = ta.value.split('\n');
        ln.innerHTML = lines.map((_,i) => `<div class="line-num">${i+1}</div>`).join('');
        document.getElementById('m-line-count').textContent = lines.length + ' lÃ­neas';
        document.getElementById('m-char-count').textContent = ta.value.length + ' chars';
    }
    function syncLineScroll() {
        const ta = document.getElementById('m-code-area');
        document.getElementById('m-line-nums').scrollTop = ta.scrollTop;
    }

    // â”€â”€ SNIPPET INSERTER (actualizado con ejemplos numÃ©ricos) â”€â”€
    function insertSnippet(type) {
        const ta = document.getElementById('m-code-area');
        const snippets = {
            'loop':  '\nloop{\n  \n}',
            'delay': '\ndelay 500',
            'if':    '\nif contador > 0 {\n  \n}',
            'oled':  '\noled.init\noled.println "Hola"\noled.print contador'
        };
        const s = snippets[type] || '';
        const pos = ta.selectionStart;
        ta.value = ta.value.slice(0,pos) + s + ta.value.slice(pos);
        ta.selectionStart = ta.selectionEnd = pos + s.length;
        ta.focus();
        syncLineNums();
    }

    function openCfg(c) {
        targetCfg=c;
        const modal = document.getElementById('modal');
        modal.style.display='block';
        document.getElementById('m-title').innerText=c.type;
        const isBRC=c.type==='BATTERY'||c.type==='RESISTOR'||c.type==='CAPACITOR';
        document.getElementById('m-val-row').style.display=isBRC?'flex':'none';
        document.getElementById('m-val').style.display=isBRC?'block':'none';
        if(isBRC)document.getElementById('m-val').value=c.val||0;
        let unit=''; if(c.type==='BATTERY')unit='V'; else if(c.type==='RESISTOR')unit='Î©'; else if(c.type==='CAPACITOR')unit='ÂµF';
        document.getElementById('m-unit').innerText=unit;
        document.getElementById('m-repair').style.display=c.burned?'inline-flex':'none';
        const tog=document.getElementById('m-toggle');
        if(c.type==='TRANSISTOR'){tog.style.display='inline-flex';tog.innerText='TYPE: '+c.mode;}else tog.style.display='none';
        const editor=document.getElementById('m-code-editor');
        const badge=document.getElementById('m-lang-badge');
        if(c.type==='RADION'){
            editor.style.display='flex';
            badge.style.display='block';
            modal.classList.add('code-mode');
            document.getElementById('m-code-area').value=c.code;
            c.intState={pc:0,wait:0,vars:{},parsed:null};
            setTimeout(syncLineNums, 50);
        } else {
            editor.style.display='none';
            badge.style.display='none';
            modal.classList.remove('code-mode');
        }
    }

    function toggleCompType() {
        if(targetCfg&&targetCfg.type==='TRANSISTOR'){
            targetCfg.mode=targetCfg.mode==='NPN'?'PNP':'NPN';
            document.getElementById('m-toggle').innerText='TYPE: '+targetCfg.mode;
        }
    }

    function closeCfg(){
        document.getElementById('modal').style.display='none';
        document.getElementById('modal').classList.remove('code-mode');
        targetCfg=null;
    }
    function saveCfg(){
        if(targetCfg){
            if(targetCfg.type==='BATTERY'||targetCfg.type==='RESISTOR'||targetCfg.type==='CAPACITOR')
                targetCfg.val=Math.max(0.1,parseFloat(document.getElementById('m-val').value)||0);
            if(targetCfg.type==='RADION'){targetCfg.code=document.getElementById('m-code-area').value;targetCfg.intState={pc:0,wait:0,vars:{},parsed:null};}
        }
        closeCfg();
    }
    function repairCfg(){if(targetCfg)targetCfg.burned=false;closeCfg();}

    function spawn(type,xOpt,yOpt){
        const tx=(xOpt!==undefined)?xOpt:vMouse.x, ty=(yOpt!==undefined)?yOpt:vMouse.y;
        const comp={type,x:tx-50,y:ty-30,w:100,h:60,nodes:[],state:0,active:false,burned:false,rotation:0,selected:false};
        if(type==='BATTERY'){comp.nodes=[{id:'+',x:0,y:30},{id:'-',x:100,y:30}];comp.val=9;}
        else if(type==='LED')comp.nodes=[{id:'A',x:0,y:30},{id:'C',x:100,y:30}];
        else if(type==='MOTOR')comp.nodes=[{id:'M1',x:0,y:30},{id:'M2',x:100,y:30}];
        else if(type==='SWITCH'||type==='PUSH_BTN'){comp.closed=false;comp.nodes=[{id:'1',x:0,y:30},{id:'2',x:100,y:30}];}
        else if(type==='CAPACITOR'){comp.nodes=[{id:'+',x:0,y:30},{id:'-',x:100,y:30}];comp.charge=0;comp.val=10;}
        else if(type==='TRANSISTOR'){comp.nodes=[{id:'C',x:20,y:10},{id:'B',x:20,y:50},{id:'E',x:80,y:30}];comp.mode='NPN';}
        else if(type==='RESISTOR'){comp.nodes=[{id:'R1',x:0,y:30},{id:'R2',x:100,y:30}];comp.val=330;}
        else if(type==='RELAY'){comp.nodes=[{id:'C+',x:10,y:15},{id:'C-',x:10,y:45},{id:'COM',x:90,y:20},{id:'NO',x:90,y:40}];comp.coilState=false;}
        else if(type==='MUX'){comp.nodes=[{id:'A',x:0,y:15},{id:'B',x:0,y:45},{id:'S',x:50,y:50},{id:'OUT',x:100,y:30}];comp.selState=false;}
        else if(type==='AND'||type==='OR'||type==='XOR')comp.nodes=[{id:'I1',x:0,y:15},{id:'I2',x:0,y:45},{id:'OUT',x:100,y:30}];
        else if(type==='NOT')comp.nodes=[{id:'PWR',x:0,y:15},{id:'IN',x:0,y:45},{id:'OUT',x:100,y:30}];
        else if(type==='RSK90'){comp.nodes=[{id:'VCC',x:20,y:10},{id:'GND',x:20,y:50},{id:'OUT',x:80,y:30}];comp.lastTick=0;comp.clockState=false;}
        else if(type==='RADION'){
            comp.w=110;comp.h=110;
            comp.nodes=[
                {id:'VCC',x:15,y:15},{id:'GND',x:15,y:35},{id:'G',x:15,y:55},
                {id:'D1',x:95,y:15},{id:'D2',x:95,y:35},{id:'D3',x:95,y:55},
                {id:'SCL',x:95,y:75},{id:'SDA',x:95,y:95}
            ];
            comp.code=`start<\npin1=D1\nloop{\n  pin1;HIGH\n  delay 500\n  pin1;LOW\n  delay 500\n}\nend>`;
            comp.memory={d1:false,d2:false,d3:false};
            comp.intState={pc:0,wait:0,vars:{},parsed:null};
        }
        else if(type==='OLED_I2C'){
            comp.w=120;comp.h=80;
            comp.nodes=[{id:'VCC',x:20,y:0},{id:'GND',x:45,y:0},{id:'SCL',x:70,y:0},{id:'SDA',x:95,y:0}];
            comp.textLines=[];comp.initialized=false;
        }
        else if(type==='WAYPOINT'){comp.x=tx-5;comp.y=ty-5;comp.w=10;comp.h=10;comp.nodes=[{id:'W',x:5,y:5}];}
        else if(type==='L298N'){
            comp.w=130; comp.h=100;
            comp.nodes=[
                {id:'VCC', x:0,  y:20}, // 0 â€” alimentaciÃ³n +
                {id:'GND', x:0,  y:50}, // 1 â€” alimentaciÃ³n GND
                {id:'IN1', x:0,  y:75}, // 2 â€” control D1 Radion
                {id:'IN2', x:30, y:100},// 3 â€” control D2 Radion
                {id:'OUT1',x:130,y:30}, // 4 â€” motor terminal A
                {id:'OUT2',x:130,y:70}, // 5 â€” motor terminal B
            ];
            comp.motorDir = 0; // -1 izq, 0 stop, 1 der
        }
        components.push(comp); return comp;
    }

    function preprocessCode(code){
        const lines=code.split('\n');let blocks={};let stack=[];
        for(let i=0;i<lines.length;i++){
            let l=lines[i].trim();
            if(l.endsWith('{'))stack.push(i);
            else if(l==='}'){if(stack.length>0){let start=stack.pop();blocks[start]=i;blocks[i]=start;}}
        }
        return{lines,blocks};
    }

    function traceWire(startNode){
        let q=[startNode],visited=[],foundComps=[];
        while(q.length>0){
            let curr=q.shift();visited.push(curr);
            connections.forEach(conn=>{
                let next=null;
                if(conn.a.n===curr)next=conn.b.n; if(conn.b.n===curr)next=conn.a.n;
                if(next&&!visited.includes(next)){
                    visited.push(next);
                    let comp=components.find(c=>c.nodes.includes(next));
                    if(comp){if(comp.type==='WAYPOINT')q.push(next);else foundComps.push({comp,node:next});}
                }
            });
        }
        return foundComps;
    }

    function getI2C_OLED(radion){
        let sclN=radion.nodes.find(n=>n.id==='SCL'),sdaN=radion.nodes.find(n=>n.id==='SDA');
        let sclC=traceWire(sclN),sdaC=traceWire(sdaN);let oled=null;
        sclC.forEach(sc=>{if(sc.comp.type==='OLED_I2C'&&sc.node.id==='SCL'){sdaC.forEach(sd=>{if(sd.comp===sc.comp&&sd.node.id==='SDA')oled=sc.comp;});}});
        return oled;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RADION LOG v1.1 â€” IntÃ©rprete mejorado con variables numÃ©ricas
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function runRadionLogic(c) {
        if (!c.active || c.burned) {
            c.memory.d1 = false; c.memory.d2 = false; c.memory.d3 = false;
            c.intState = { pc:0, wait:0, vars:{}, parsed:null };
            return;
        }
        if (!c.intState) c.intState = { pc:0, wait:0, vars:{}, parsed:null };
        if (!c.intState.parsed) c.intState.parsed = preprocessCode(c.code);

        const now = Date.now();
        if (c.intState.wait > now) return;

        const { lines, blocks } = c.intState.parsed;
        let ix = 0;
        const max = 50;

        // â”€â”€ EvalÃºa expresiÃ³n aritmÃ©tica / valor atÃ³mico â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function evalExpr(expr) {
            expr = expr.trim();

            // Operadores de baja precedencia: + -
            const opsLow = ['+', '-'];
            for (let i = expr.length - 1; i >= 0; i--) {
                const ch = expr[i];
                if (opsLow.includes(ch)) {
                    if (i === 0) continue;
                    const prev = expr[i-1];
                    if ('+-*/%(=<>!'.includes(prev)) continue;
                    const left = evalExpr(expr.slice(0, i));
                    const right = evalExpr(expr.slice(i + 1));
                    const nl = parseFloat(left), nr = parseFloat(right);
                    if (isNaN(nl) || isNaN(nr)) return String(left) + String(right);
                    return ch === '+' ? nl + nr : nl - nr;
                }
            }

            // Operadores de alta precedencia: * / %
            const opsHigh = ['*', '/', '%'];
            for (let i = expr.length - 1; i >= 0; i--) {
                const ch = expr[i];
                if (opsHigh.includes(ch)) {
                    if (i === 0) continue;
                    const prev = expr[i-1];
                    if ('+-*/%(=<>!'.includes(prev)) continue;
                    const left = evalExpr(expr.slice(0, i));
                    const right = evalExpr(expr.slice(i + 1));
                    const nl = parseFloat(left), nr = parseFloat(right);
                    if (isNaN(nl) || isNaN(nr)) return 0;
                    if (ch === '*') return nl * nr;
                    if (ch === '/') return nr !== 0 ? nl / nr : 0;
                    if (ch === '%') return nr !== 0 ? nl % nr : 0;
                }
            }

            // Valor atÃ³mico
            if (!isNaN(parseFloat(expr)) && isFinite(expr)) return parseFloat(expr);
            if (expr === 'HIGH') return 1;
            if (expr === 'LOW')  return 0;

            // Variable
            const v = c.intState.vars[expr];
            if (v !== undefined) {
                if (v === 'D1') return c.nodes[3].signal ? 1 : 0;
                if (v === 'D2') return c.nodes[4].signal ? 1 : 0;
                if (v === 'D3') return c.nodes[5].signal ? 1 : 0;
                const vn = parseFloat(v);
                if (!isNaN(vn)) return vn;
                return v;
            }
            return expr;
        }

        // â”€â”€ EvalÃºa condiciÃ³n: A op B â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function evalCond(condStr) {
            const operators = ['>=', '<=', '!=', '==', '>', '<'];
            for (const op of operators) {
                const idx = condStr.indexOf(op);
                if (idx === -1) continue;
                const lv = evalExpr(condStr.slice(0, idx).trim());
                const rv = evalExpr(condStr.slice(idx + op.length).trim());
                const ln = parseFloat(lv), rn = parseFloat(rv);
                if (!isNaN(ln) && !isNaN(rn)) {
                    if (op === '==') return ln === rn;
                    if (op === '!=') return ln !== rn;
                    if (op === '>')  return ln > rn;
                    if (op === '<')  return ln < rn;
                    if (op === '>=') return ln >= rn;
                    if (op === '<=') return ln <= rn;
                }
                // ComparaciÃ³n string (HIGH/LOW)
                const ls = String(lv), rs = String(rv);
                if (op === '==') return ls === rs;
                if (op === '!=') return ls !== rs;
                return false;
            }
            // Sin operador: truthy
            const v = evalExpr(condStr);
            return v !== 0 && v !== 'LOW' && v !== '' && v !== false;
        }

        // â”€â”€ Resuelve token a string para mostrar en OLED â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function resolveDisplay(token) {
            if (token.startsWith('"') && token.endsWith('"')) return token.slice(1, -1);
            const val = evalExpr(token);
            if (typeof val === 'number') {
                return Number.isInteger(val) ? String(val) : parseFloat(val.toFixed(4)).toString();
            }
            return String(val);
        }

        // â”€â”€ Bucle principal del intÃ©rprete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        while (ix < max) {
            if (c.intState.pc >= lines.length) break;
            let line = lines[c.intState.pc].trim();

            // Saltar vacÃ­os, comentarios, delimitadores
            if (!line || line.startsWith('//') || line === 'start<' || line === 'end>') {
                c.intState.pc++; ix++; continue;
            }

            // â”€â”€ if <condicion> { â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (line.startsWith('if ')) {
                const condMatch = line.match(/^if\s+(.+?)\s*\{$/);
                let cond = false;
                if (condMatch) cond = evalCond(condMatch[1].trim());
                if (cond) {
                    c.intState.pc++;
                } else {
                    c.intState.pc = (blocks[c.intState.pc] !== undefined)
                        ? blocks[c.intState.pc] + 1
                        : c.intState.pc + 1;
                }
                ix++; continue;
            }

            // â”€â”€ Bloque abierto { â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (line.endsWith('{')) { c.intState.pc++; ix++; continue; }

            // â”€â”€ Cierre de bloque } â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (line === '}') {
                const sl = blocks[c.intState.pc];
                if (sl !== undefined) {
                    if (lines[sl].trim().startsWith('loop')) {
                        c.intState.pc = sl + 1; ix++; continue;
                    } else {
                        c.intState.pc++;
                    }
                } else {
                    c.intState.pc++;
                }
                ix++; continue;
            }

            // â”€â”€ delay <expr_ms> â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (line.startsWith('delay ')) {
                const ms = parseFloat(evalExpr(line.slice(6).trim())) || 100;
                c.intState.wait = now + ms;
                c.intState.pc++;
                return;
            }

            // â”€â”€ oled.* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (line.startsWith('oled.')) {
                const oled = getI2C_OLED(c);
                if (oled && oled.active && !oled.burned) {
                    if (line === 'oled.init') {
                        oled.textLines = [""]; oled.initialized = true;

                    } else if (line.startsWith('oled.print ') || line.startsWith('oled.println ')) {
                        const isPrintln = line.startsWith('oled.println ');
                        const raw = line.slice(isPrintln ? 13 : 11).trim();
                        const text = resolveDisplay(raw);
                        if (oled.initialized) {
                            if (!oled.textLines.length) oled.textLines.push("");
                            oled.textLines[oled.textLines.length - 1] += text;
                            if (isPrintln) {
                                if (oled.textLines.length >= 4) oled.textLines.shift();
                                oled.textLines.push("");
                            }
                        }

                    } else if (line === 'oled.clear') {
                        if (oled.initialized) oled.textLines = [""];
                    }
                }
                c.intState.pc++; ix++; continue;
            }

            // â”€â”€ var;HIGH / var;LOW (con condiciÃ³n inline opcional) â”€
            if (line.includes(';')) {
                const parts = line.split(';');
                const varName = parts[0].trim();
                const rest = parts[1].trim();

                // Â¿Tiene "HIGH if <cond>" o "LOW if <cond>"?
                const inlineIf = rest.match(/^(HIGH|LOW)\s+if\s+(.+)$/);
                let state;
                if (inlineIf) {
                    const cond = evalCond(inlineIf[2].trim());
                    if (!cond) { c.intState.pc++; ix++; continue; }
                    state = inlineIf[1] === 'HIGH';
                } else {
                    state = rest === 'HIGH';
                }

                const pinVar = c.intState.vars[varName];
                if (pinVar === 'D1' || varName === 'D1') c.memory.d1 = state;
                if (pinVar === 'D2' || varName === 'D2') c.memory.d2 = state;
                if (pinVar === 'D3' || varName === 'D3') c.memory.d3 = state;
                c.intState.pc++; ix++; continue;
            }

            // â”€â”€ var = expr (asignaciÃ³n numÃ©rica o de pin) â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (line.includes('=') && !line.startsWith('if ')) {
                const eqIdx = line.indexOf('=');
                const varName = line.slice(0, eqIdx).trim();
                const exprStr = line.slice(eqIdx + 1).trim();

                // Pin fÃ­sico directo
                if (exprStr === 'D1' || exprStr === 'D2' || exprStr === 'D3') {
                    c.intState.vars[varName] = exprStr;
                } else {
                    c.intState.vars[varName] = evalExpr(exprStr);
                }
                c.intState.pc++; ix++; continue;
            }

            // LÃ­nea no reconocida â†’ avanzar
            c.intState.pc++; ix++;
        }
    }

    function updatePhysics(){
        components.forEach(c=>{c.state=0;if(c.type!=='CAPACITOR')c.active=false;if(c.type==='RELAY')c.coilActiveThisFrame=false;});
        connections.forEach(conn=>{conn.active=false;conn.flowDir=1;});
        components.filter(c=>c.type==='CAPACITOR').forEach(cap=>{if(cap.charge>0)cap.isSource=true;else{cap.isSource=false;cap.active=false;}});
        components.forEach(c=>c.nodes.forEach(n=>n.signal=false));
        const sources=components.filter(c=>(c.type==='BATTERY'||(c.type==='CAPACITOR'&&c.isSource)||(c.type==='RSK90'&&c.clockState)||(c.type==='RADION'&&(c.memory.d1||c.memory.d2||c.memory.d3)))&&!c.burned);
        sources.forEach(src=>{
            let startNodes=[];
            if(src.type==='BATTERY'||src.type==='CAPACITOR')startNodes.push(src.nodes[0]);
            else if(src.type==='RSK90')startNodes.push(src.nodes[2]);
            else if(src.type==='RADION'){if(src.memory.d1)startNodes.push(src.nodes[3]);if(src.memory.d2)startNodes.push(src.nodes[4]);if(src.memory.d3)startNodes.push(src.nodes[5]);}
            startNodes.forEach(sn=>{
                let q=[sn];sn.signal=true;
                while(q.length>0){
                    let curr=q.shift();
                    connections.forEach(conn=>{let next=null;if(conn.a.n===curr)next=conn.b.n;if(conn.b.n===curr)next=conn.a.n;if(next&&!next.signal){next.signal=true;q.push(next);}});
                    const comp=components.find(c=>c.nodes.includes(curr));
                    if(comp&&!comp.burned){
                        if((comp.type==='SWITCH'||comp.type==='PUSH_BTN')&&!comp.closed)continue;
                        if(comp.type==='RELAY'){if((curr===comp.nodes[2]||curr===comp.nodes[3])&&!comp.coilState)continue;}
                        if(comp.type==='MUX'){const sel=comp.selState;if(curr===comp.nodes[0]){if(!sel&&!comp.nodes[3].signal){comp.nodes[3].signal=true;q.push(comp.nodes[3]);}}else if(curr===comp.nodes[1]){if(sel&&!comp.nodes[3].signal){comp.nodes[3].signal=true;q.push(comp.nodes[3]);}}else if(curr===comp.nodes[3]){let dest=sel?comp.nodes[1]:comp.nodes[0];if(!dest.signal){dest.signal=true;q.push(dest);}}continue;}
                        if(comp.type==='LED'&&curr!==comp.nodes[0])continue;
                        if(comp.type==='CAPACITOR'&&curr!==comp.nodes[0])continue;
                        if(comp.type==='TRANSISTOR')continue;
                        if(['AND','OR','NOT','XOR','RSK90','RADION','OLED_I2C'].includes(comp.type))continue;
                        if(comp.type==='L298N')continue;
                        comp.nodes.forEach(n=>{if(!n.signal){n.signal=true;q.push(n);}});
                    }
                }
            });
        });
        components.filter(c=>(c.type==='BATTERY'||(c.type==='CAPACITOR'&&c.isSource))&&!c.burned).forEach(bat=>{
            let foundPaths=[];
            function dfs(currentNode,currentPath,visitedNodes){
                if(currentNode===bat.nodes[1]){foundPaths.push([...currentPath]);return;}
                connections.forEach(conn=>{
                    if(conn.a.n===currentNode&&!visitedNodes.includes(conn.b.n))dfs(conn.b.n,[...currentPath,{t:'wire',c:conn,dir:1}],[...visitedNodes,conn.b.n]);
                    if(conn.b.n===currentNode&&!visitedNodes.includes(conn.a.n))dfs(conn.a.n,[...currentPath,{t:'wire',c:conn,dir:-1}],[...visitedNodes,conn.a.n]);
                });
                const comp=components.find(c=>c.nodes.includes(currentNode));
                if(comp&&comp!==bat&&!comp.burned){
                    let outNodes=[];let direction=(currentNode===comp.nodes[0])?1:-1;
                    if(comp.type==='TRANSISTOR'){if(currentNode===comp.nodes[0])outNodes.push(comp.nodes[2]);else if(currentNode===comp.nodes[2])outNodes.push(comp.nodes[0]);}
                    else if(['AND','OR','NOT','XOR'].includes(comp.type)){if(currentNode===comp.nodes[0]||currentNode===comp.nodes[1])outNodes.push(comp.nodes[2]);}
                    else if(comp.type==='RELAY'){if(currentNode===comp.nodes[0])outNodes.push(comp.nodes[1]);if(currentNode===comp.nodes[1])outNodes.push(comp.nodes[0]);if(currentNode===comp.nodes[2])outNodes.push(comp.nodes[3]);if(currentNode===comp.nodes[3])outNodes.push(comp.nodes[2]);}
                    else if(comp.type==='MUX'){const sel=comp.selState;if(currentNode===comp.nodes[0]&&!sel)outNodes.push(comp.nodes[3]);if(currentNode===comp.nodes[1]&&sel)outNodes.push(comp.nodes[3]);if(currentNode===comp.nodes[3]){if(sel)outNodes.push(comp.nodes[1]);else outNodes.push(comp.nodes[0]);}}
                    else if(comp.type==='RSK90'){if(currentNode===comp.nodes[0]){outNodes.push(comp.nodes[1]);outNodes.push(comp.nodes[2]);}if(currentNode===comp.nodes[1])outNodes.push(comp.nodes[0]);if(currentNode===comp.nodes[2])outNodes.push(comp.nodes[0]);}
                    else if(comp.type==='RADION'){
                        if(currentNode===comp.nodes[0]){outNodes.push(comp.nodes[1]);outNodes.push(comp.nodes[2]);}
                        if(currentNode===comp.nodes[1]){outNodes.push(comp.nodes[2]);outNodes.push(comp.nodes[0]);}
                        if(currentNode===comp.nodes[2]){outNodes.push(comp.nodes[1]);outNodes.push(comp.nodes[0]);}
                        if(comp.memory.d1){if(currentNode===comp.nodes[0])outNodes.push(comp.nodes[3]);if(currentNode===comp.nodes[3])outNodes.push(comp.nodes[0]);}
                        if(comp.memory.d2){if(currentNode===comp.nodes[0])outNodes.push(comp.nodes[4]);if(currentNode===comp.nodes[4])outNodes.push(comp.nodes[0]);}
                        if(comp.memory.d3){if(currentNode===comp.nodes[0])outNodes.push(comp.nodes[5]);if(currentNode===comp.nodes[5])outNodes.push(comp.nodes[0]);}
                    }
                    else if(comp.type==='OLED_I2C'){if(currentNode===comp.nodes[0])outNodes.push(comp.nodes[1]);}
                    else if(comp.type==='L298N'){
                        // nodos: 0=VCC, 1=GND, 2=IN1, 3=IN2, 4=OUT1, 5=OUT2
                        // AlimentaciÃ³n interna VCCâ†”GND
                        if(currentNode===comp.nodes[0])outNodes.push(comp.nodes[1]);
                        if(currentNode===comp.nodes[1])outNodes.push(comp.nodes[0]);
                        const in1=comp.nodes[2].signal, in2=comp.nodes[3].signal;
                        // FWD (IN1=H, IN2=L): VCCâ†’OUT1, OUT2â†’GND (puente H)
                        if(in1&&!in2){
                            if(currentNode===comp.nodes[0])outNodes.push(comp.nodes[4]); // VCC â†’ OUT1
                            if(currentNode===comp.nodes[4])outNodes.push(comp.nodes[0]); // OUT1 â† VCC
                            if(currentNode===comp.nodes[5])outNodes.push(comp.nodes[1]); // OUT2 â†’ GND
                            if(currentNode===comp.nodes[1])outNodes.push(comp.nodes[5]); // GND â†’ OUT2
                        }
                        // REV (IN1=L, IN2=H): VCCâ†’OUT2, OUT1â†’GND (puente H invertido)
                        if(!in1&&in2){
                            if(currentNode===comp.nodes[0])outNodes.push(comp.nodes[5]); // VCC â†’ OUT2
                            if(currentNode===comp.nodes[5])outNodes.push(comp.nodes[0]); // OUT2 â† VCC
                            if(currentNode===comp.nodes[4])outNodes.push(comp.nodes[1]); // OUT1 â†’ GND
                            if(currentNode===comp.nodes[1])outNodes.push(comp.nodes[4]); // GND â†’ OUT1
                        }
                    }
                    else{outNodes.push(comp.nodes.find(n=>n!==currentNode));}
                    outNodes.forEach(otherNode=>{
                        if(otherNode&&!visitedNodes.includes(otherNode)){
                            let canCross=false;
                            if(comp.type==='RESISTOR'||comp.type==='MOTOR'||comp.type==='WAYPOINT')canCross=true;
                            if((comp.type==='SWITCH'||comp.type==='PUSH_BTN')&&comp.closed)canCross=true;
                            if(comp.type==='RELAY'){if((currentNode===comp.nodes[0]&&otherNode===comp.nodes[1])||(currentNode===comp.nodes[1]&&otherNode===comp.nodes[0]))canCross=true;if((currentNode===comp.nodes[2]&&otherNode===comp.nodes[3])||(currentNode===comp.nodes[3]&&otherNode===comp.nodes[2])){if(comp.coilState)canCross=true;}}
                            if(comp.type==='MUX')canCross=true;
                            if(comp.type==='LED'&&direction===1)canCross=true;
                            if(comp.type==='CAPACITOR'&&bat.type==='BATTERY')canCross=true;
                            if(comp.type==='AND'&&comp.nodes[0].signal&&comp.nodes[1].signal)canCross=true;
                            if(comp.type==='OR'&&(comp.nodes[0].signal||comp.nodes[1].signal))canCross=true;
                            if(comp.type==='XOR'&&((comp.nodes[0].signal&&!comp.nodes[1].signal)||(!comp.nodes[0].signal&&comp.nodes[1].signal)))canCross=true;
                            if(comp.type==='NOT'&&currentNode===comp.nodes[0]&&!comp.nodes[1].signal)canCross=true;
                            if(comp.type==='RSK90'){if((currentNode===comp.nodes[0]&&otherNode===comp.nodes[1])||(currentNode===comp.nodes[1]&&otherNode===comp.nodes[0]))canCross=true;if(comp.clockState&&((currentNode===comp.nodes[0]&&otherNode===comp.nodes[2])||(currentNode===comp.nodes[2]&&otherNode===comp.nodes[0])))canCross=true;}
                            if(comp.type==='RADION'){const isPwr=(n)=>n===comp.nodes[0]||n===comp.nodes[1]||n===comp.nodes[2];if(isPwr(currentNode)&&isPwr(otherNode))canCross=true;if(comp.memory.d1&&((currentNode===comp.nodes[0]&&otherNode===comp.nodes[3])||(currentNode===comp.nodes[3]&&otherNode===comp.nodes[0])))canCross=true;if(comp.memory.d2&&((currentNode===comp.nodes[0]&&otherNode===comp.nodes[4])||(currentNode===comp.nodes[4]&&otherNode===comp.nodes[0])))canCross=true;if(comp.memory.d3&&((currentNode===comp.nodes[0]&&otherNode===comp.nodes[5])||(currentNode===comp.nodes[5]&&otherNode===comp.nodes[0])))canCross=true;}
                            if(comp.type==='OLED_I2C'){const isPwr=(n)=>n===comp.nodes[0]||n===comp.nodes[1];if(isPwr(currentNode)&&isPwr(otherNode))canCross=true;}
                            if(comp.type==='L298N'){
                                const in1=comp.nodes[2].signal, in2=comp.nodes[3].signal;
                                const vcc=comp.nodes[0], gnd=comp.nodes[1], o1=comp.nodes[4], o2=comp.nodes[5];
                                // Siempre: VCCâ†”GND para alimentaciÃ³n interna
                                if((currentNode===vcc&&otherNode===gnd)||(currentNode===gnd&&otherNode===vcc))canCross=true;
                                // FWD: VCCâ†’OUT1 y OUT2â†’GND
                                if(in1&&!in2){
                                    if((currentNode===vcc&&otherNode===o1)||(currentNode===o1&&otherNode===vcc))canCross=true;
                                    if((currentNode===o2&&otherNode===gnd)||(currentNode===gnd&&otherNode===o2))canCross=true;
                                }
                                // REV: VCCâ†’OUT2 y OUT1â†’GND
                                if(!in1&&in2){
                                    if((currentNode===vcc&&otherNode===o2)||(currentNode===o2&&otherNode===vcc))canCross=true;
                                    if((currentNode===o1&&otherNode===gnd)||(currentNode===gnd&&otherNode===o1))canCross=true;
                                }
                            }
                            if(comp.type==='TRANSISTOR'){const bs=comp.nodes[1].signal;if(comp.mode==='NPN'){if(bs)canCross=true;}else{if(!bs)canCross=true;}}
                            if(canCross)dfs(otherNode,[...currentPath,{t:'comp',comp,dir:direction}],[...visitedNodes,otherNode]);
                        }
                    });
                }
            }
            dfs(bat.nodes[0],[],[bat.nodes[0]]);
            if(foundPaths.length>0){
                if(bat.type==='CAPACITOR')bat.charge-=2.0;
                foundPaths.forEach(path=>{
                    let rSum=0.1,ledCount=0,pathComps=[];
                    path.forEach(step=>{
                        if(step.t==='comp'){
                            pathComps.push(step.comp);
                            if(step.comp.type==='RESISTOR')rSum+=step.comp.val;
                            if(step.comp.type==='RELAY')rSum+=50;
                            if(step.comp.type==='RSK90')rSum+=1000;
                            if(step.comp.type==='RADION')rSum+=1200;
                            if(step.comp.type==='OLED_I2C')rSum+=1000;
                            if(step.comp.type==='L298N')rSum+=800;
                            if(step.comp.type==='LED')ledCount++;
                            if(['AND','OR','NOT','XOR','MUX'].includes(step.comp.type))rSum+=10;
                            if(step.comp.type==='CAPACITOR'&&bat.type==='BATTERY'){let cr=50/(step.comp.val||10);step.comp.charge=Math.min(100,step.comp.charge+cr);step.comp.active=true;}
                        }
                    });
                    let vNet=bat.val-(ledCount*2),current=vNet>0?(vNet/rSum):0,popped=false;
                    if(current>0){
                        if(bat.type==='BATTERY'&&current>5.0){bat.burned=true;popped=true;}
                        pathComps.forEach(c=>{
                            if(c.type==='LED'&&current>0.035){c.burned=true;popped=true;}
                            if(c.type==='RESISTOR'&&(current*current*c.val)>0.5){c.burned=true;popped=true;}
                            if(['AND','OR','NOT','XOR','MUX'].includes(c.type)&&current>0.2){c.burned=true;popped=true;}
                            if(c.type==='TRANSISTOR'&&current>1.0){c.burned=true;popped=true;}
                            if(c.type==='OLED_I2C'&&current>0.5){c.burned=true;popped=true;}
                        });
                    }
                    if(!popped&&current>0){
                        bat.active=true;
                        path.forEach(step=>{
                            if(step.t==='wire'){step.c.active=true;step.c.flowDir=step.dir;}
                            if(step.t==='comp'){step.comp.active=true;if(step.comp.type==='LED')step.comp.state=1;if(step.comp.type==='MOTOR')step.comp.state=step.dir;if(step.comp.type==='RELAY')step.comp.coilActiveThisFrame=true;}
                        });
                    }
                });
            }
        });
        components.filter(c=>c.type==='RELAY').forEach(r=>r.coilState=r.coilActiveThisFrame);
        components.filter(c=>c.type==='MUX').forEach(m=>{m.selState=m.nodes[2].signal;});
        // L298N: calcular direcciÃ³n segÃºn IN1/IN2
        components.filter(c=>c.type==='L298N').forEach(d=>{
            const in1=d.nodes[2].signal, in2=d.nodes[3].signal;
            if(in1&&!in2) d.motorDir=1;
            else if(!in1&&in2) d.motorDir=-1;
            else d.motorDir=0;
        });
        components.filter(c=>c.type==='RSK90').forEach(c=>{
            if(c.active&&!c.burned){const now=Date.now();if(!c.lastTick)c.lastTick=now;if(now-c.lastTick>=1000){c.clockState=!c.clockState;c.lastTick=now;}}
            else{c.clockState=false;c.lastTick=0;}
        });
        components.filter(c=>c.type==='RADION').forEach(c=>runRadionLogic(c));
    }

    // â”€â”€â”€ DRAW â”€â”€â”€
    function drawGrid(camX,camY,zoom){
        const size=50;
        const halfW=(canvas.width/2)/zoom,halfH=(canvas.height/2)/zoom;
        const sx=Math.floor((camX-halfW)/size)*size-size,ex=camX+halfW+size;
        const sy=Math.floor((camY-halfH)/size)*size-size,ey=camY+halfH+size;

        ctx.strokeStyle='rgba(255,255,255,0.06)';
        ctx.lineWidth=1/zoom;
        ctx.beginPath();
        for(let x=sx;x<ex;x+=size){ ctx.moveTo(x,sy); ctx.lineTo(x,ey); }
        for(let y=sy;y<ey;y+=size){ ctx.moveTo(sx,y); ctx.lineTo(ex,y); }
        ctx.stroke();

        ctx.strokeStyle='rgba(0,212,255,0.07)';
        ctx.lineWidth=1/zoom;
        ctx.beginPath();
        for(let x=sx;x<ex;x+=size*5){ ctx.moveTo(x,sy); ctx.lineTo(x,ey); }
        for(let y=sy;y<ey;y+=size*5){ ctx.moveTo(sx,y); ctx.lineTo(ex,y); }
        ctx.stroke();

        ctx.fillStyle='rgba(255,255,255,0.18)';
        for(let x=sx;x<ex;x+=size)for(let y=sy;y<ey;y+=size)ctx.fillRect(x-0.8/zoom,y-0.8/zoom,1.6/zoom,1.6/zoom);
    }

    const C_BODY  = 'rgba(18,26,46,0.85)';
    const C_BORD  = 'rgba(255,255,255,0.13)';
    const C_BORD_ACTIVE = 'rgba(0,212,255,0.5)';
    const C_BORD_BURN   = 'rgba(255,71,87,0.6)';
    const C_TEXT  = '#8892a4';
    const C_TEXT2 = '#3d4559';
    const C_CYAN  = '#00d4ff';
    const C_GREEN = '#00e676';
    const C_AMBER = '#ffb700';
    const C_RED   = '#ff4757';

    function baseRect(c,dW,dH,override){
        ctx.fillStyle = override || C_BODY;
        ctx.strokeStyle = c.burned ? C_BORD_BURN : (c.active ? C_BORD_ACTIVE : C_BORD);
        ctx.lineWidth = 1;
        ctx.fillRect(c.x,c.y,dW,dH);
        ctx.strokeRect(c.x,c.y,dW,dH);
    }

    function label(text,x,y,color,size){
        ctx.fillStyle=color||C_TEXT2;
        ctx.font=`${size||8}px 'DM Mono', monospace`;
        ctx.fillText(text,x,y);
    }

    function draw(){
        if(targetCfg==null&&!isDesktopMode){
            if(vMouse.moving.up)vMouse.y-=vMouse.speed; if(vMouse.moving.down)vMouse.y+=vMouse.speed;
            if(vMouse.moving.left)vMouse.x-=vMouse.speed; if(vMouse.moving.right)vMouse.x+=vMouse.speed;
        }
        if(!isDesktopMode){
            const em=50;
            let smx=(vMouse.x-camera.x)*camera.zoom+canvas.width/2;
            let smy=(vMouse.y-camera.y)*camera.zoom+canvas.height/2;
            if(smx<em)camera.x-=(em-smx)/camera.zoom;
            if(smx>canvas.width-em)camera.x+=(smx-(canvas.width-em))/camera.zoom;
            if(smy<em)camera.y-=(em-smy)/camera.zoom;
            if(smy>canvas.height-em)camera.y+=(smy-(canvas.height-em))/camera.zoom;
        }
        if(vMouse.selectionMode&&selectionBox&&!isDesktopMode){selectionBox.w=vMouse.x-selectionBox.x;selectionBox.h=vMouse.y-selectionBox.y;}
        if(!isDesktopMode){
            if(vMouse.isDown&&!vMouse.lastDown&&targetCfg==null&&!vMouse.selectionMode){
                let clickOk=false,nHit=null;
                components.forEach(c=>c.nodes.forEach(n=>{if(Math.hypot(c.x+n.x-vMouse.x,c.y+n.y-vMouse.y)<20)nHit={c,n};}));
                if(nHit){drawingCable=nHit;clickOk=true;}
                else{let ch=components.find(c=>vMouse.x>c.x&&vMouse.x<c.x+c.w&&vMouse.y>c.y&&vMouse.y<c.y+c.h);if(ch){clickOk=true;if(selectedItems.includes(ch))draggingComp={group:true,ref:ch,ox:vMouse.x,oy:vMouse.y};else{selectedItems.forEach(c=>c.selected=false);selectedItems=[];draggingComp={c:ch,ox:vMouse.x-ch.x,oy:vMouse.y-ch.y};}}}
                if(!clickOk&&selectedItems.length>0){selectedItems.forEach(c=>c.selected=false);selectedItems=[];}
            }else if(!vMouse.isDown&&vMouse.lastDown){
                if(drawingCable){let tH=null;components.forEach(c=>c.nodes.forEach(n=>{if(c!==drawingCable.c&&Math.hypot(c.x+n.x-vMouse.x,c.y+n.y-vMouse.y)<20)tH={c,n};}));if(tH)connections.push({a:drawingCable,b:tH});else{const wp=spawn('WAYPOINT');connections.push({a:drawingCable,b:{c:wp,n:wp.nodes[0]}});}}
                draggingComp=drawingCable=null;
            }
        }
        if(draggingComp){
            if(draggingComp.group){const dx=vMouse.x-draggingComp.ox,dy=vMouse.y-draggingComp.oy;selectedItems.forEach(c=>{c.x+=dx;c.y+=dy;});draggingComp.ox=vMouse.x;draggingComp.oy=vMouse.y;}
            else{draggingComp.c.x=vMouse.x-draggingComp.ox;draggingComp.c.y=vMouse.y-draggingComp.oy;}
        }
        vMouse.lastDown=vMouse.isDown;
        updatePhysics(); rotAnim+=0.2; time+=0.5;

        document.getElementById('cx').textContent=Math.round(vMouse.x);
        document.getElementById('cy').textContent=Math.round(vMouse.y);
        document.getElementById('cz').textContent=camera.zoom.toFixed(1);

        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.save();
        ctx.translate(canvas.width/2,canvas.height/2);
        ctx.scale(camera.zoom,camera.zoom);
        ctx.translate(-camera.x,-camera.y);

        drawGrid(camera.x,camera.y,camera.zoom);

        connections.forEach(conn=>{
            const ax=conn.a.c.x+conn.a.n.x,ay=conn.a.c.y+conn.a.n.y;
            const bx=conn.b.c.x+conn.b.n.x,by=conn.b.c.y+conn.b.n.y;
            if(conn.active){
                ctx.strokeStyle='rgba(0,212,255,0.08)'; ctx.lineWidth=7; ctx.setLineDash([]);
                ctx.beginPath(); ctx.moveTo(ax,ay); ctx.lineTo(bx,by); ctx.stroke();
                ctx.strokeStyle='rgba(0,212,255,0.7)'; ctx.lineWidth=1.5;
                ctx.setLineDash([5,5]); ctx.lineDashOffset=-time*conn.flowDir;
                ctx.beginPath(); ctx.moveTo(ax,ay); ctx.lineTo(bx,by); ctx.stroke();
                ctx.setLineDash([]);
            }else{
                ctx.strokeStyle='rgba(255,255,255,0.08)'; ctx.lineWidth=1.5; ctx.setLineDash([]);
                ctx.beginPath(); ctx.moveTo(ax,ay); ctx.lineTo(bx,by); ctx.stroke();
            }
        });

        if(drawingCable){
            ctx.strokeStyle='rgba(0,212,255,0.4)'; ctx.lineWidth=1.5; ctx.setLineDash([4,4]);
            ctx.beginPath(); ctx.moveTo(drawingCable.c.x+drawingCable.n.x,drawingCable.c.y+drawingCable.n.y); ctx.lineTo(vMouse.x,vMouse.y); ctx.stroke(); ctx.setLineDash([]);
        }

        components.forEach(c=>{
            if(c.type==='WAYPOINT'){
                ctx.fillStyle='rgba(255,255,255,0.15)'; ctx.beginPath(); ctx.arc(c.x+5,c.y+5,3,0,Math.PI*2); ctx.fill(); return;
            }
            ctx.save();
            ctx.translate(c.x+c.w/2,c.y+c.h/2); ctx.rotate(c.rotation*Math.PI/2); ctx.translate(-(c.x+c.w/2),-(c.y+c.h/2));

            if(c.selected||selectedItems.includes(c)){
                let dW=(c.rotation%2===0)?c.w:c.h,dH=(c.rotation%2===0)?c.h:c.w;
                ctx.strokeStyle='rgba(0,212,255,0.5)'; ctx.lineWidth=1; ctx.setLineDash([4,4]);
                ctx.strokeRect(c.x-5,c.y-5,dW+10,dH+10); ctx.setLineDash([]);
            }

            let dW=(c.rotation%2===0)?c.w:c.h, dH=(c.rotation%2===0)?c.h:c.w;

            if(c.type==='LED'){
                baseRect(c,dW,dH);
                if(c.state&&!c.burned){
                    ctx.fillStyle='rgba(255,220,80,0.06)'; ctx.fillRect(c.x,c.y,dW,dH);
                    ctx.shadowBlur=14; ctx.shadowColor='rgba(255,220,80,0.5)';
                }
                ctx.strokeStyle=c.state&&!c.burned?'rgba(255,220,80,0.9)':(c.burned?C_RED:'rgba(255,255,255,0.2)');
                ctx.lineWidth=1.2;
                ctx.beginPath(); ctx.moveTo(c.x+38,c.y+16); ctx.lineTo(c.x+38,c.y+44); ctx.lineTo(c.x+62,c.y+30); ctx.closePath(); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(c.x+62,c.y+16); ctx.lineTo(c.x+62,c.y+44); ctx.stroke();
                ctx.shadowBlur=0;
                label('LED',c.x+43,c.y+56);
            }
            else if(c.type==='MOTOR'){
                baseRect(c,dW,dH);
                ctx.strokeStyle=c.state!==0&&!c.burned?C_GREEN:'rgba(255,255,255,0.15)'; ctx.lineWidth=1.2;
                ctx.beginPath(); ctx.arc(c.x+50,c.y+30,15,0,Math.PI*2); ctx.stroke();
                ctx.fillStyle=C_TEXT; ctx.font="bold 11px 'DM Mono'"; ctx.fillText('M',c.x+47,c.y+34);
                if(c.state!==0&&!c.burned){
                    ctx.save(); ctx.translate(c.x+50,c.y+30); ctx.rotate(rotAnim*c.state);
                    ctx.strokeStyle='rgba(0,230,118,0.6)'; ctx.lineWidth=1;
                    ctx.beginPath(); ctx.arc(0,0,20,0,Math.PI*0.7); ctx.stroke();
                    ctx.fillStyle=C_GREEN; ctx.beginPath(); ctx.moveTo(20,-4); ctx.lineTo(25,4); ctx.lineTo(15,4); ctx.fill();
                    ctx.restore();
                }
            }
            else if(c.type==='SWITCH'||c.type==='PUSH_BTN'){
                baseRect(c,dW,dH);
                ctx.strokeStyle=c.closed?C_GREEN:'rgba(255,255,255,0.2)'; ctx.lineWidth=1.2;
                if(c.closed){ctx.shadowBlur=6;ctx.shadowColor='rgba(0,230,118,0.3)';}
                ctx.beginPath(); ctx.moveTo(c.x+18,c.y+30);
                if(c.closed)ctx.lineTo(c.x+82,c.y+30); else ctx.lineTo(c.x+65,c.y+14); ctx.stroke(); ctx.shadowBlur=0;
                if(c.type==='PUSH_BTN'){
                    ctx.fillStyle=c.closed?C_GREEN:'rgba(255,255,255,0.2)';
                    ctx.beginPath(); ctx.arc(c.x+50,c.y+50,4,0,Math.PI*2); ctx.fill();
                }
                label(c.type==='SWITCH'?'SW':'BTN',c.x+40,c.y+10);
            }
            else if(c.type==='RELAY'){
                baseRect(c,dW,dH);
                ctx.strokeStyle=c.coilState?C_GREEN:'rgba(255,255,255,0.15)'; ctx.lineWidth=1;
                ctx.beginPath(); ctx.moveTo(c.x+12,c.y+15);
                for(let i=0;i<4;i++){ctx.arc(c.x+12,c.y+20+(i*6),3,Math.PI*1.5,Math.PI*0.5,false);ctx.arc(c.x+12,c.y+23+(i*6),3,Math.PI*0.5,Math.PI*1.5,true);}
                ctx.lineTo(c.x+12,c.y+45); ctx.stroke();
                ctx.strokeStyle='rgba(255,255,255,0.2)'; ctx.lineWidth=1.2;
                ctx.beginPath(); ctx.moveTo(c.x+88,c.y+20); if(c.coilState)ctx.lineTo(c.x+88,c.y+40); else ctx.lineTo(c.x+78,c.y+34); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(c.x+88,c.y+40); ctx.lineTo(c.x+88,c.y+45); ctx.stroke();
                label('COIL',c.x+18,c.y+32); label('SW',c.x+70,c.y+32);
            }
            else if(c.type==='MUX'){
                const sel=c.selState;
                ctx.fillStyle='rgba(0,212,255,0.04)'; ctx.strokeStyle=sel?C_CYAN:'rgba(0,212,255,0.3)'; ctx.lineWidth=1;
                ctx.beginPath(); ctx.moveTo(c.x+22,c.y+10); ctx.lineTo(c.x+78,c.y+20); ctx.lineTo(c.x+78,c.y+40); ctx.lineTo(c.x+22,c.y+50); ctx.closePath(); ctx.fill(); ctx.stroke();
                ctx.fillStyle=sel?C_TEXT2:C_CYAN; ctx.beginPath(); ctx.arc(c.x+32,c.y+22,3,0,Math.PI*2); ctx.fill();
                ctx.fillStyle=sel?C_CYAN:C_TEXT2; ctx.beginPath(); ctx.arc(c.x+32,c.y+38,3,0,Math.PI*2); ctx.fill();
                label('MUX',c.x+37,c.y+33,C_CYAN,9);
                label('A',c.x+5,c.y+16); label('B',c.x+5,c.y+42); label('S',c.x+44,c.y+55); label('Q',c.x+82,c.y+33);
            }
            else if(c.type==='RSK90'){
                baseRect(c,dW,dH,'rgba(255,183,0,0.04)');
                ctx.strokeStyle=c.active?C_AMBER:'rgba(255,183,0,0.2)'; ctx.lineWidth=1;
                ctx.strokeRect(c.x+14,c.y+8,72,44);
                ctx.fillStyle=c.clockState?C_AMBER:'rgba(255,183,0,0.2)';
                if(c.clockState){ctx.shadowBlur=8;ctx.shadowColor='rgba(255,183,0,0.5)';}
                ctx.beginPath(); ctx.arc(c.x+50,c.y+30,5,0,Math.PI*2); ctx.fill(); ctx.shadowBlur=0;
                label('RSK90',c.x+34,c.y+24,C_AMBER,9);
                label('VCC',c.x+18,c.y+17); label('GND',c.x+18,c.y+45); label('OUT',c.x+60,c.y+35);
            }
            else if(c.type==='RADION'){
                ctx.fillStyle='rgba(14,30,22,0.88)'; ctx.strokeStyle=c.active?'rgba(0,230,118,0.45)':'rgba(0,230,118,0.15)'; ctx.lineWidth=1;
                ctx.fillRect(c.x+30,c.y+5,50,100); ctx.strokeRect(c.x+30,c.y+5,50,100);
                ctx.fillStyle='rgba(0,0,0,0.3)'; ctx.fillRect(c.x+36,c.y+22,38,56);
                ctx.strokeStyle='rgba(0,230,118,0.15)'; ctx.strokeRect(c.x+36,c.y+22,38,56);
                ctx.save(); ctx.translate(c.x+47,c.y+76); ctx.rotate(-Math.PI/2);
                label('RADION 1.1',0,0,'rgba(0,230,118,0.5)',7); ctx.restore();
                if(c.active&&!c.burned){ctx.fillStyle=C_GREEN;ctx.shadowBlur=5;ctx.shadowColor=C_GREEN;ctx.beginPath();ctx.arc(c.x+67,c.y+27,2,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;}
                label('VCC',c.x+2,c.y+18); label('GND',c.x+2,c.y+38); label('GND',c.x+2,c.y+58);
                label('D1',c.x+82,c.y+18,C_GREEN); label('D2',c.x+82,c.y+38,C_GREEN); label('D3',c.x+82,c.y+58,C_GREEN);
                label('SCL',c.x+82,c.y+78,C_AMBER); label('SDA',c.x+82,c.y+98,C_AMBER);
                [['d1',c.x+40,c.y+28],['d2',c.x+40,c.y+40],['d3',c.x+40,c.y+52]].forEach(([k,px,py])=>{
                    ctx.fillStyle=c.memory&&c.memory[k]?C_GREEN:'rgba(255,255,255,0.06)';
                    ctx.beginPath(); ctx.arc(px,py,2,0,Math.PI*2); ctx.fill();
                });
            }
            else if(c.type==='L298N'){
                // Cuerpo principal
                ctx.fillStyle='rgba(20,14,36,0.9)';
                ctx.strokeStyle=c.active&&!c.burned?'rgba(167,139,250,0.55)':'rgba(167,139,250,0.2)';
                ctx.lineWidth=1;
                ctx.fillRect(c.x,c.y,c.w,c.h); ctx.strokeRect(c.x,c.y,c.w,c.h);
                // Chip interior
                ctx.fillStyle='rgba(0,0,0,0.35)'; ctx.fillRect(c.x+20,c.y+18,90,54);
                ctx.strokeStyle='rgba(167,139,250,0.2)'; ctx.strokeRect(c.x+20,c.y+18,90,54);
                // Label chip
                ctx.fillStyle='rgba(167,139,250,0.7)'; ctx.font="bold 10px 'DM Mono',monospace";
                ctx.fillText('L298N',c.x+42,c.y+40);
                ctx.fillStyle='rgba(167,139,250,0.35)'; ctx.font="7px 'DM Mono',monospace";
                ctx.fillText('MOTOR DRIVER',c.x+30,c.y+54);
                // Indicadores IN1/IN2
                const in1=c.nodes[2].signal, in2=c.nodes[3].signal;
                ctx.fillStyle=in1?'rgba(0,230,118,0.8)':'rgba(255,255,255,0.1)';
                ctx.beginPath(); ctx.arc(c.x+35,c.y+65,4,0,Math.PI*2); ctx.fill();
                ctx.fillStyle=in2?'rgba(0,230,118,0.8)':'rgba(255,255,255,0.1)';
                ctx.beginPath(); ctx.arc(c.x+55,c.y+65,4,0,Math.PI*2); ctx.fill();
                ctx.fillStyle='rgba(167,139,250,0.4)'; ctx.font="7px 'DM Mono',monospace";
                ctx.fillText('IN1',c.x+28,c.y+78); ctx.fillText('IN2',c.x+48,c.y+78);
                // DirecciÃ³n del motor
                const dir=c.motorDir;
                if(dir!==0&&!c.burned){
                    ctx.fillStyle='rgba(167,139,250,0.7)';
                    ctx.font="9px 'DM Mono',monospace";
                    ctx.fillText(dir===1?'â†’ FWD':'â† REV',c.x+70,c.y+68);
                    ctx.shadowBlur=6; ctx.shadowColor='rgba(167,139,250,0.5)';
                    ctx.strokeStyle='rgba(167,139,250,0.6)'; ctx.lineWidth=1.5;
                    ctx.beginPath(); ctx.arc(c.x+95,c.y+44,8,0,Math.PI*0.75*dir+Math.PI*(dir===-1?1:0)); ctx.stroke();
                    ctx.shadowBlur=0;
                }
                // Pin labels
                label('VCC',c.x-22,c.y+23,'rgba(0,230,118,0.6)');
                label('GND',c.x-22,c.y+53,'rgba(255,71,87,0.5)');
                label('IN1',c.x-22,c.y+78,'rgba(167,139,250,0.6)');
                label('IN2',c.x+8, c.y+103,'rgba(167,139,250,0.6)');
                label('OUT1',c.x+133,c.y+33,'rgba(0,230,118,0.6)');
                label('OUT2',c.x+133,c.y+73,'rgba(0,230,118,0.6)');
            }
            else if(c.type==='OLED_I2C'){
                ctx.fillStyle='rgba(18,26,46,0.85)'; ctx.strokeStyle=c.burned?C_RED:C_BORD; ctx.lineWidth=1;
                ctx.fillRect(c.x,c.y,c.w,c.h); ctx.strokeRect(c.x,c.y,c.w,c.h);
                ctx.fillStyle='rgba(0,0,0,0.7)'; ctx.fillRect(c.x+4,c.y+14,c.w-8,c.h-18);
                ctx.strokeStyle='rgba(255,255,255,0.05)'; ctx.strokeRect(c.x+4,c.y+14,c.w-8,c.h-18);
                label('VCC',c.x+10,c.y+11); label('GND',c.x+37,c.y+11); label('SCL',c.x+62,c.y+11,C_AMBER); label('SDA',c.x+88,c.y+11,C_AMBER);
                if(c.active&&!c.burned&&c.initialized&&c.textLines){
                    ctx.fillStyle='rgba(0,230,118,0.85)'; ctx.font="9.5px 'DM Mono',monospace";
                    ctx.shadowBlur=3; ctx.shadowColor='rgba(0,230,118,0.4)';
                    for(let i=0;i<c.textLines.length;i++) ctx.fillText(c.textLines[i],c.x+7,c.y+26+(i*13));
                    ctx.shadowBlur=0;
                }
            }
            else if(c.type==='BATTERY'){
                baseRect(c,dW,dH);
                ctx.fillStyle='rgba(0,212,255,0.04)'; ctx.fillRect(c.x+10,c.y+16,75,28);
                ctx.strokeStyle=c.active&&!c.burned?'rgba(0,212,255,0.5)':'rgba(255,255,255,0.1)'; ctx.lineWidth=1;
                ctx.strokeRect(c.x+10,c.y+16,75,28);
                ctx.fillStyle='rgba(255,255,255,0.1)'; ctx.fillRect(c.x+85,c.y+22,5,16);
                ctx.fillStyle=c.active&&!c.burned?C_CYAN:C_TEXT;
                ctx.font="bold 12px 'DM Mono'"; ctx.fillText(`${c.val}V`,c.x+37,c.y+35);
                label('BATT',c.x+42,c.y+54);
            }
            else if(c.type==='CAPACITOR'){
                baseRect(c,dW,dH);
                const pct=c.charge/100;
                ctx.strokeStyle='rgba(255,255,255,0.15)'; ctx.lineWidth=1.2;
                ctx.beginPath(); ctx.moveTo(c.x+35,c.y+10); ctx.lineTo(c.x+35,c.y+50); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(c.x+50,c.y+10); ctx.lineTo(c.x+50,c.y+50); ctx.stroke();
                ctx.fillStyle='rgba(0,212,255,0.1)'; ctx.fillRect(c.x+38,c.y+12,10,36);
                ctx.fillStyle=`rgba(0,212,255,${0.3+pct*0.5})`; ctx.fillRect(c.x+38,c.y+12+(36*(1-pct)),10,36*pct);
                label(`${Math.floor(c.charge)}%`,c.x+32,c.y+62,C_CYAN);
                label(`${c.val}ÂµF`,c.x+32,c.y+8);
            }
            else if(c.type==='TRANSISTOR'){
                baseRect(c,dW,dH);
                ctx.strokeStyle='rgba(255,255,255,0.2)'; ctx.lineWidth=1.2;
                ctx.beginPath(); ctx.arc(c.x+50,c.y+30,18,0,Math.PI*2); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(c.x+42,c.y+15); ctx.lineTo(c.x+42,c.y+45); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(c.x+42,c.y+30); ctx.lineTo(c.x+22,c.y+50); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(c.x+42,c.y+20); ctx.lineTo(c.x+62,c.y+10); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(c.x+42,c.y+40); ctx.lineTo(c.x+80,c.y+30); ctx.stroke();
                ctx.fillStyle='rgba(255,255,255,0.6)';
                if(c.mode==='NPN'){ctx.beginPath();ctx.moveTo(c.x+70,c.y+32);ctx.lineTo(c.x+60,c.y+35);ctx.lineTo(c.x+62,c.y+28);ctx.fill();}
                else{ctx.beginPath();ctx.moveTo(c.x+47,c.y+39);ctx.lineTo(c.x+57,c.y+36);ctx.lineTo(c.x+55,c.y+43);ctx.fill();}
                label(c.mode,c.x+36,c.y+33,C_TEXT);
                label('C',c.x+26,c.y+14); label('E',c.x+70,c.y+24); label('B',c.x+26,c.y+48);
            }
            else if(c.type==='RESISTOR'){
                baseRect(c,dW,dH);
                ctx.strokeStyle=c.burned?C_RED:'rgba(255,183,0,0.5)'; ctx.lineWidth=1.2;
                ctx.beginPath(); ctx.moveTo(c.x+16,c.y+30); ctx.lineTo(c.x+27,c.y+20); ctx.lineTo(c.x+37,c.y+40); ctx.lineTo(c.x+47,c.y+20); ctx.lineTo(c.x+57,c.y+40); ctx.lineTo(c.x+67,c.y+30); ctx.stroke();
                label(`${c.val}Î©`,c.x+34,c.y+13,C_AMBER);
            }
            else if(['AND','OR','NOT','XOR'].includes(c.type)){
                const ac=c.active&&!c.burned;
                ctx.fillStyle=ac?'rgba(0,212,255,0.06)':'rgba(255,255,255,0.03)';
                ctx.strokeStyle=ac?'rgba(0,212,255,0.6)':(c.burned?C_RED:'rgba(255,255,255,0.15)'); ctx.lineWidth=1.2;
                if(c.type==='AND'){ctx.beginPath();ctx.moveTo(c.x+28,c.y+14);ctx.lineTo(c.x+62,c.y+14);ctx.arc(c.x+62,c.y+30,16,-Math.PI/2,Math.PI/2);ctx.lineTo(c.x+28,c.y+46);ctx.closePath();ctx.fill();ctx.stroke();}
                else if(c.type==='OR'){ctx.beginPath();ctx.moveTo(c.x+28,c.y+14);ctx.quadraticCurveTo(c.x+50,c.y+14,c.x+72,c.y+30);ctx.quadraticCurveTo(c.x+50,c.y+46,c.x+28,c.y+46);ctx.quadraticCurveTo(c.x+46,c.y+30,c.x+28,c.y+14);ctx.fill();ctx.stroke();}
                else if(c.type==='XOR'){ctx.beginPath();ctx.moveTo(c.x+34,c.y+14);ctx.quadraticCurveTo(c.x+56,c.y+14,c.x+72,c.y+30);ctx.quadraticCurveTo(c.x+56,c.y+46,c.x+34,c.y+46);ctx.quadraticCurveTo(c.x+50,c.y+30,c.x+34,c.y+14);ctx.fill();ctx.stroke();ctx.beginPath();ctx.moveTo(c.x+26,c.y+14);ctx.quadraticCurveTo(c.x+42,c.y+30,c.x+26,c.y+46);ctx.stroke();}
                else if(c.type==='NOT'){ctx.beginPath();ctx.moveTo(c.x+28,c.y+14);ctx.lineTo(c.x+70,c.y+30);ctx.lineTo(c.x+28,c.y+46);ctx.closePath();ctx.fill();ctx.stroke();ctx.beginPath();ctx.arc(c.x+73,c.y+30,3,0,Math.PI*2);ctx.stroke();label('PWR',c.x+3,c.y+12);label('IN',c.x+5,c.y+55);}
                label(c.type,c.x+(c.type==='NOT'?37:30),c.y+33,ac?C_CYAN:'rgba(255,255,255,0.2)',9);
            }

            if(c.burned){
                ctx.fillStyle='rgba(255,71,87,0.07)'; ctx.fillRect(c.x,c.y,dW,dH);
                ctx.fillStyle=C_RED; ctx.font="8px 'DM Mono'"; ctx.fillText('BURNED',c.x+dW/2-20,c.y-4);
            }

            ctx.restore();

            c.nodes.forEach(n=>{
                let nc='rgba(255,255,255,0.15)';
                if(n.id==='+'||n.id==='A'||n.id==='M1'||n.id==='R1'||n.id==='I1'||n.id==='I2'||n.id==='PWR'||n.id==='IN'||n.id==='C+'||n.id==='VCC')nc='rgba(0,230,118,0.6)';
                else if(n.id==='-'||n.id==='C'||n.id==='M2'||n.id==='R2'||n.id==='GND'||n.id==='G')nc='rgba(255,71,87,0.5)';
                if(c.type==='TRANSISTOR'||c.type==='MUX'||n.id==='S'||n.id==='COM'||n.id==='OUT')nc='rgba(0,212,255,0.5)';
                if(c.type==='RADION'&&(n.id==='D1'||n.id==='D2'||n.id==='D3'))nc='rgba(0,230,118,0.7)';
                if((c.type==='RADION'||c.type==='OLED_I2C')&&(n.id==='SCL'||n.id==='SDA'))nc='rgba(255,183,0,0.6)';
                if(c.type==='RELAY'&&n.id==='NO')nc='rgba(255,71,87,0.5)';
                if(c.type==='L298N'&&(n.id==='IN1'||n.id==='IN2'))nc='rgba(167,139,250,0.6)';
                if(c.type==='L298N'&&(n.id==='OUT1'||n.id==='OUT2'))nc='rgba(0,230,118,0.6)';

                ctx.fillStyle=nc;
                ctx.beginPath(); ctx.arc(c.x+n.x,c.y+n.y,4,0,Math.PI*2); ctx.fill();
                if(n.signal){
                    ctx.strokeStyle='rgba(0,212,255,0.8)'; ctx.lineWidth=1;
                    ctx.shadowBlur=5; ctx.shadowColor='rgba(0,212,255,0.5)';
                    ctx.beginPath(); ctx.arc(c.x+n.x,c.y+n.y,6,0,Math.PI*2); ctx.stroke();
                    ctx.shadowBlur=0;
                }
            });
        });

        if(selectionBox){
            ctx.strokeStyle='rgba(0,212,255,0.5)'; ctx.lineWidth=1; ctx.setLineDash([3,3]);
            ctx.strokeRect(selectionBox.x,selectionBox.y,selectionBox.w,selectionBox.h);
            ctx.fillStyle='rgba(0,212,255,0.04)'; ctx.fillRect(selectionBox.x,selectionBox.y,selectionBox.w,selectionBox.h);
            ctx.setLineDash([]);
        }

        ctx.strokeStyle='rgba(255,255,255,0.2)'; ctx.lineWidth=1;
        ctx.beginPath(); ctx.arc(vMouse.x,vMouse.y,5,0,Math.PI*2); ctx.stroke();
        ctx.strokeStyle='rgba(255,255,255,0.1)';
        ctx.beginPath(); ctx.moveTo(vMouse.x-12,vMouse.y); ctx.lineTo(vMouse.x-6,vMouse.y); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(vMouse.x+6,vMouse.y); ctx.lineTo(vMouse.x+12,vMouse.y); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(vMouse.x,vMouse.y-12); ctx.lineTo(vMouse.x,vMouse.y-6); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(vMouse.x,vMouse.y+6); ctx.lineTo(vMouse.x,vMouse.y+12); ctx.stroke();

        ctx.restore();

        ctx.fillStyle='rgba(255,255,255,0.08)';
        ctx.font="9px 'DM Mono',monospace";
        ctx.textAlign='right';
        ctx.fillText('Simulic Pro v1.8',canvas.width-14,canvas.height-12);
        ctx.textAlign='left';

        requestAnimationFrame(draw);
    }

    draw();
</script>

</body>
</html>
